---
phase: 05-auth-and-cloud-sync
plan: 03
type: execute
wave: 3
depends_on:
  - 05-01
  - 05-02
autonomous: false
files_modified:
  - app/(tabs)/settings.tsx
  - app/(tabs)/favorites.tsx
requirements:
  - AUTH-01
  - FAV-03

must_haves:
  truths:
    - "Settings screen shows auth section at the bottom: 'Sign in to sync favorites' row when logged out; email + Sign Out when logged in"
    - "Tapping 'Sign in to sync favorites' in Settings opens the auth modal (router.push('/auth'))"
    - "After signing out, Settings reverts to the 'Sign in' row immediately"
    - "Favorites screen shows a subtle sync-nudge row at the top when logged out: 'Sign in to sync across devices'"
    - "When logged in, Favorites screen shows a subtle cloud icon indicator in the header area"
    - "All existing favorites functionality (toggle, list, empty state) works unchanged for both logged-in and logged-out users"
  artifacts:
    - path: "app/(tabs)/settings.tsx"
      provides: "Auth section at bottom of Settings: conditional render based on user from useAuth(); Sign Out calls signOut() from AuthContext"
      contains: "useAuth"
    - path: "app/(tabs)/favorites.tsx"
      provides: "Sync nudge row at top when !user; cloud icon when user present; existing favorites list unchanged"
      contains: "useAuth"
  key_links:
    - from: "app/(tabs)/settings.tsx"
      to: "src/context/AuthContext.tsx"
      via: "useAuth() — user, signOut"
      pattern: "useAuth"
    - from: "app/(tabs)/settings.tsx"
      to: "app/auth.tsx"
      via: "router.push('/auth') from 'Sign in' row"
      pattern: "router.push.*auth"
    - from: "app/(tabs)/favorites.tsx"
      to: "src/context/AuthContext.tsx"
      via: "useAuth() — user"
      pattern: "useAuth"
    - from: "app/(tabs)/favorites.tsx"
      to: "app/auth.tsx"
      via: "router.push('/auth') from nudge row"
      pattern: "router.push.*auth"
---

<objective>
Wire the auth UI into the two screens that users interact with: Settings (auth entry point with sign out) and Favorites (sync nudge for discoverability). Then verify the complete Phase 5 flow end-to-end on device.

Purpose: Plans 01 and 02 built the auth plumbing and sync logic. This plan surfaces them in the UI at the exact locations decided in context: auth section at the bottom of Settings (locked decision), and a subtle nudge on the Favorites screen (Claude's discretion — surfaces auth where the value proposition is highest).
Output: Settings with functional auth section; Favorites with sync nudge; phase verified end-to-end on device.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-auth-and-cloud-sync/05-RESEARCH.md
@.planning/phases/05-auth-and-cloud-sync/05-01-SUMMARY.md
@.planning/phases/05-auth-and-cloud-sync/05-02-SUMMARY.md
@app/(tabs)/settings.tsx
@app/(tabs)/favorites.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auth section to Settings screen and sync nudge to Favorites screen</name>
  <files>
    app/(tabs)/settings.tsx
    app/(tabs)/favorites.tsx
  </files>
  <action>
**Part A: Update app/(tabs)/settings.tsx**

Read the current settings.tsx (from Phase 4). It has sections: Playback, Appearance, Notifications, Support. Add an "Account" section at the BOTTOM of the screen (below Support), as decided in context (auth is optional, shouldn't be prominent).

The section renders conditionally based on `user` from `useAuth()`:

**When logged out (user === null):**
```typescript
// Single row — tap opens auth modal
<TouchableOpacity style={styles.row} onPress={() => router.push('/auth')}>
  <View style={{ flex: 1 }}>
    <Text style={[styles.label, { color: labelColor }]}>Sign in to sync favorites</Text>
    <Text style={[styles.sub, { color: subColor }]}>Keep your favorites across devices</Text>
  </View>
  <MaterialIcons name="chevron-right" size={20} color={subColor} />
</TouchableOpacity>
```

**When logged in (user !== null):**
```typescript
// Shows email address and Sign Out button
<View style={styles.row}>
  <View style={{ flex: 1 }}>
    <Text style={[styles.label, { color: labelColor }]}>Signed in</Text>
    <Text style={[styles.sub, { color: subColor }]} numberOfLines={1}>
      {user.email}
    </Text>
  </View>
</View>
<View style={styles.divider} />
<TouchableOpacity
  style={styles.row}
  onPress={async () => { await signOut(); }}
>
  <Text style={[styles.label, { color: '#ef4444' }]}>Sign Out</Text>
</TouchableOpacity>
```

Add these imports to settings.tsx:
```typescript
import { router } from 'expo-router';
import { useAuth } from '@/src/context/AuthContext';
```

Add inside the component (alongside existing `useUIStore` call):
```typescript
const { user, signOut } = useAuth();
```

Add the Account section in the JSX (at the bottom of the ScrollView, above the `<View style={{ height: 120 }} />` spacer):

```typescript
{/* Account — at bottom, auth is optional and not prominent */}
<Text style={[styles.sectionHeader, { color: headerColor }]}>ACCOUNT</Text>
<View style={[styles.section, { backgroundColor: sectionBg }]}>
  {user ? (
    <>
      <View style={styles.row}>
        <View style={{ flex: 1 }}>
          <Text style={[styles.label, { color: labelColor }]}>Signed in</Text>
          <Text style={[styles.sub, { color: subColor }]} numberOfLines={1}>
            {user.email}
          </Text>
        </View>
      </View>
      <View style={styles.divider} />
      <TouchableOpacity
        style={styles.row}
        onPress={async () => { await signOut(); }}
        accessibilityRole="button"
        accessibilityLabel="Sign out of your account"
      >
        <Text style={[styles.label, { color: '#ef4444' }]}>Sign Out</Text>
      </TouchableOpacity>
    </>
  ) : (
    <TouchableOpacity
      style={styles.row}
      onPress={() => router.push('/auth')}
      accessibilityRole="button"
      accessibilityLabel="Sign in to sync favorites"
    >
      <View style={{ flex: 1 }}>
        <Text style={[styles.label, { color: labelColor }]}>Sign in to sync favorites</Text>
        <Text style={[styles.sub, { color: subColor }]}>Keep your favorites across devices</Text>
      </View>
      <MaterialIcons name="chevron-right" size={20} color={subColor} />
    </TouchableOpacity>
  )}
</View>
```

Do NOT modify any other section (Playback, Appearance, Notifications, Support). Read the file first, then add only the Account section and the two new imports.

**Part B: Update app/(tabs)/favorites.tsx**

Read the current favorites.tsx (from Phase 4 plan 04-03). It renders a FlatList of favorites with an empty state. Add two small additions:

1. Import `useAuth` and `router` at the top
2. Get `user` from `useAuth()` in the component
3. Add a sync nudge row as `ListHeaderComponent` when not logged in
4. Add a subtle cloud sync indicator in the header when logged in

The nudge row (shown only when `!user`):
```typescript
// Subtle nudge — not a banner, just a soft row
const SyncNudgeRow = () => (
  <TouchableOpacity
    style={nudgeStyles.row}
    onPress={() => router.push('/auth')}
    accessibilityRole="button"
    accessibilityLabel="Sign in to sync favorites across devices"
  >
    <MaterialIcons name="cloud-upload" size={18} color="rgba(139,92,246,0.7)" />
    <Text style={nudgeStyles.text}>Sign in to sync across devices</Text>
    <MaterialIcons name="chevron-right" size={16} color="rgba(255,255,255,0.3)" />
  </TouchableOpacity>
);

const nudgeStyles = StyleSheet.create({
  row: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingVertical: 12,
    gap: 10,
    backgroundColor: 'rgba(139,92,246,0.06)',
    borderRadius: 12,
    marginHorizontal: 16,
    marginBottom: 12,
  },
  text: {
    flex: 1,
    color: 'rgba(255,255,255,0.55)',
    fontSize: 14,
  },
});
```

The cloud indicator (shown when `user` is set) — add to the screen header area, near the "Favorites" title text:
```typescript
// Small cloud icon next to the header title when synced
{user && (
  <MaterialIcons
    name="cloud-done"
    size={16}
    color="rgba(139,92,246,0.7)"
    style={{ marginLeft: 6 }}
  />
)}
```

In the FlatList, update `ListHeaderComponent`:
```typescript
ListHeaderComponent={
  <>
    {/* Screen header row */}
    <View style={styles.headerRow}>
      <Text style={styles.title}>Favorites</Text>
      {user && (
        <MaterialIcons name="cloud-done" size={16} color="rgba(139,92,246,0.7)" />
      )}
    </View>
    {/* Sync nudge — only shown when not logged in */}
    {!user && <SyncNudgeRow />}
  </>
}
```

Read the existing favorites.tsx carefully first. If it has a different header structure (e.g., outside the FlatList, in a SafeAreaView header), adapt the approach to fit the existing structure while achieving the same visual outcome: cloud icon when logged in, nudge row when logged out.

Do NOT change the FlatList data, renderItem, empty state, or any favorites toggle behavior. Only add auth-aware UI elements.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

    # TypeScript check
    npx tsc --noEmit 2>&1 | head -20

    # Settings: useAuth import and user + signOut usage
    grep "useAuth\|signOut\|user\.email" app/\(tabs\)/settings.tsx

    # Settings: auth section navigates to /auth
    grep "router.push.*auth\|push.*\/auth" app/\(tabs\)/settings.tsx

    # Settings: Sign Out button exists
    grep "Sign Out" app/\(tabs\)/settings.tsx

    # Favorites: useAuth import
    grep "useAuth" app/\(tabs\)/favorites.tsx

    # Favorites: sync nudge row
    grep "sync\|cloud-upload\|cloud-done\|Sign in to sync" app/\(tabs\)/favorites.tsx

    # Favorites: existing favorites functionality unchanged (no FAV-related removals)
    grep "FlatList\|toggleFavorite\|useFavoritesStore" app/\(tabs\)/favorites.tsx
    ```
    TypeScript clean. All greps return matches. Favorites FlatList and store usage still present.
  </verify>
  <done>
    - Settings has an "ACCOUNT" section at the bottom
    - When logged out: "Sign in to sync favorites" row with chevron; tap opens /auth modal
    - When logged in: user email displayed; "Sign Out" button in red that calls `signOut()`
    - Favorites screen has `SyncNudgeRow` component (shown only when !user) above the list
    - Favorites header shows cloud-done icon (subtle, purple-tinted) when user is logged in
    - All existing Phase 4 favorites functionality (toggle, FlatList, empty state) unchanged
    - TypeScript passes with no errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Phase 5 Auth and Cloud Sync end-to-end on device</name>
  <action>No automated action — this checkpoint requires human verification of the full auth flow on a device or simulator.</action>
  <what-built>
    Complete Phase 5 Auth and Cloud Sync:
    - 05-01: Firebase Auth with RN persistence, AuthContext, auth modal screen (/auth), Firestore security rules
    - 05-02: FavoritesService (Firestore read/write/migration), useFavoritesSync hook (silent background sync), root layout wired
    - 05-03: Settings auth section (sign in / sign out), Favorites sync nudge and cloud icon
  </what-built>
  <how-to-verify>
    Run the app on a simulator or device (EAS Development Build required):
    ```bash
    npx expo start
    ```

    Test each Phase 5 success criterion:

    **1. Anonymous mode (AUTH-01) — all features work without account:**
    - Launch the app fresh
    - Browse the library, tap a sound — audio plays normally
    - Star several sounds as favorites — they appear in Favorites tab
    - Open Settings — auth section shows "Sign in to sync favorites"
    - Favorites tab shows "Sign in to sync across devices" nudge row
    - Confirm: no screen forces authentication, no redirects to auth

    **2. Sign up and sign in (AUTH-02) — email/password auth:**
    - In Settings: tap "Sign in to sync favorites" → auth modal opens
    - In auth modal: tap "Need an account? Sign up"
    - Enter a valid email + password (6+ chars) → tap "Create Account"
    - Modal dismisses automatically
    - Settings now shows email address and "Sign Out" button
    - Favorites tab now shows cloud-done icon instead of nudge row

    **3. Anonymous-to-cloud migration (FAV-03) — no data loss:**
    - Before signing up (step above), save 2-3 sounds as favorites while anonymous
    - Sign up with the above flow
    - After modal closes: Favorites tab should still show the same favorites (migration ran silently)
    - No loading indicator should have appeared during this process

    **4. Firestore sync (AUTH-03) — favorites sync across sessions:**
    - With a signed-in account, save 1 new favorite
    - Close and reopen the app
    - Verify: user is still signed in (not prompted to log in again — session persisted)
    - Verify: the new favorite is still present (loaded from Firestore on app open)

    **5. Sign out behavior:**
    - In Settings: tap "Sign Out"
    - Settings reverts to "Sign in to sync favorites" row
    - Favorites tab: cloud icon gone, nudge row appears
    - Favorites list: still shows the local favorites (not cleared on logout)
    - Audio playback and other features still work normally

    **6. Cross-device simulation (AUTH-03 deduplication):**
    - On the same simulator: sign in with the same account
    - Verify favorites load from Firestore (the account's cloud set)
    - If you had local favorites that differ from cloud: confirm no duplicates appear
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria pass, or describe any issues found (auth failure, migration not running, session not persisting, favorites lost on logout, etc.)</resume-signal>
</task>

</tasks>

<verification>
After Task 1 completes (before checkpoint):

```bash
cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

# Full TypeScript check
npx tsc --noEmit

# Settings: auth section present
grep -n "ACCOUNT\|Sign in to sync\|Sign Out\|useAuth" app/\(tabs\)/settings.tsx

# Favorites: auth-aware additions
grep -n "useAuth\|cloud-done\|cloud-upload\|SyncNudgeRow" app/\(tabs\)/favorites.tsx

# Auth flow end-to-end: key wiring present
grep "useFavoritesSync" app/_layout.tsx
grep "migrateLocalToCloud" src/hooks/useFavoritesSync.ts
grep "setDoc.*merge" src/services/FavoritesService.ts
grep "request.auth.uid == uid" firestore.rules
```
</verification>

<success_criteria>
Phase 5 complete when ALL are true (verified in checkpoint):
1. All free features accessible without account — browsing, playing, favoriting all work anonymously
2. Sign up and sign in work with email + password via the auth modal in Settings
3. Favorites saved while anonymous appear in the account after first login (migration ran silently)
4. User remains signed in after app restart (session persisted via AsyncStorage)
5. After login, favorites load from Firestore on next app open
6. Sign out reverts Settings and Favorites UI to anonymous state; local favorites preserved
7. `npx tsc --noEmit` exits 0 across all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-and-cloud-sync/05-03-SUMMARY.md` documenting:
- Settings auth section: what was added, how the conditional rendering works
- Favorites auth additions: nudge row and cloud icon placement decisions
- Checkpoint results: which criteria passed, any issues found and how resolved
- Any deviations from the plan (especially if favorites.tsx structure differed from assumptions)
- Phase 5 overall: notable patterns or decisions that affect Phase 6 planning
</output>
