---
phase: 06-freemium-and-monetization
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/data/sounds.ts
  - src/components/FavoriteButton.tsx
  - src/components/SoundCard.tsx
  - src/components/LockBadge.tsx
  - src/components/PremiumGate.tsx
  - src/services/PremiumPaywallService.ts
  - app/(tabs)/index.tsx
  - app/(tabs)/favorites.tsx
  - app/(tabs)/settings.tsx
autonomous: false
requirements:
  - LIB-04
  - AUTH-04

user_setup:
  - service: revenuecat
    why: "RevenueCat dashboard must have entitlement, products, and offering configured before the native paywall can display"
    dashboard_config:
      - task: "Create Monthly subscription product in App Store Connect and link to RevenueCat"
        location: "App Store Connect → Subscriptions → create, then RevenueCat Dashboard → Products → + New"
      - task: "Create Annual subscription product in App Store Connect and link to RevenueCat"
        location: "App Store Connect → Subscriptions → create, then RevenueCat Dashboard → Products → + New"
      - task: "Create 'premium' entitlement and attach both Monthly and Annual products to it"
        location: "RevenueCat Dashboard → Entitlements → premium → attach products"
      - task: "Create a Default Offering with both Monthly and Annual packages"
        location: "RevenueCat Dashboard → Offerings → Default → + Add Package (monthly, annual)"
      - task: "For Android: create equivalent products in Google Play Console and add to RevenueCat"
        location: "Google Play Console → Monetization → Subscriptions, then RevenueCat Dashboard"

must_haves:
  truths:
    - "Premium sounds show a lock badge in the top-right corner of their card in the library"
    - "Tapping a locked sound card opens the RevenueCat paywall immediately — no preview, no teaser"
    - "Free users tapping the favorite button on a premium sound see the paywall instead of adding to favorites"
    - "The paywall is never shown during fullscreen immersive mode"
    - "After purchase, paywall dismisses and premium sounds unlock immediately (no app restart)"
    - "Purchase error or cancellation shows 'Purchase didn't complete. Try again.' — both CANCELLED and ERROR result in the same brief message"
    - "Restore purchases is accessible from the Settings screen"
    - "A premium banner/entry point is visible in the library header and Settings screen for free users"
    - "The Favorites screen shows a subscription nudge row for free users"
  artifacts:
    - path: "src/data/sounds.ts"
      provides: "isPremium field present on at least 4 sounds (set to true for premium catalog entries)"
      contains: "isPremium: true"
    - path: "src/components/LockBadge.tsx"
      provides: "Lock badge component: lock icon + 'Premium' text, absolute positioned top-right, subtle dark background"
      exports: ["LockBadge"]
      min_lines: 25
    - path: "src/components/PremiumGate.tsx"
      provides: "PremiumGate wrapper: renders children normally for premium users; wraps in Pressable + LockBadge for free users"
      exports: ["PremiumGate"]
      min_lines: 30
    - path: "src/services/PremiumPaywallService.ts"
      provides: "openPaywall() helper — guards fullscreen check, presents RevenueCatUI.presentPaywall(), handles all PAYWALL_RESULT cases"
      exports: ["openPaywall"]
      min_lines: 35
    - path: "app/(tabs)/index.tsx"
      provides: "Library screen: premium SoundCards wrapped in PremiumGate; premium banner row for free users"
      contains: "PremiumGate"
    - path: "app/(tabs)/favorites.tsx"
      provides: "Favorites screen: subscription nudge row for free users above favorites list"
      contains: "openPaywall"
    - path: "app/(tabs)/settings.tsx"
      provides: "Settings screen: 'Restore Purchases' row and premium subscription entry point for free users"
      contains: "restorePurchases"
  key_links:
    - from: "src/components/SoundCard.tsx"
      to: "src/components/PremiumGate.tsx"
      via: "PremiumGate wraps SoundCard; onLockedPress calls openPaywall()"
      pattern: "PremiumGate"
    - from: "src/services/PremiumPaywallService.ts"
      to: "react-native-purchases-ui"
      via: "RevenueCatUI.presentPaywall() — locked decision: use RevenueCat default template"
      pattern: "presentPaywall"
    - from: "src/services/PremiumPaywallService.ts"
      to: "src/stores/uiStore.ts"
      via: "useUIStore.getState().isImmersiveMode — paywall blocked during fullscreen"
      pattern: "isImmersiveMode"
    - from: "app/(tabs)/settings.tsx"
      to: "react-native-purchases"
      via: "Purchases.restorePurchases() for Restore Purchases row"
      pattern: "restorePurchases"
---

<objective>
Mark premium sounds in the catalog, build the lock badge + PremiumGate components, create the openPaywall() helper that guards fullscreen and handles all PAYWALL_RESULT cases, add lock indicators to SoundCard, and wire paywall entry points into the library, favorites, and settings screens.

Purpose: Plan 06-01 established premium state flow. This plan makes that state visible to the user and routes them to the paywall. Premium sounds are visible in the library but clearly locked — and every tap path (sound card, favorite button, library banner, Favorites nudge, Settings) correctly routes free users to RevenueCat's native paywall.

Output: Full lock indicator system + RevenueCat paywall integration + proactive paywall entry points in library, favorites, and settings screens.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-freemium-and-monetization/06-RESEARCH.md
@.planning/phases/06-freemium-and-monetization/06-01-SUMMARY.md
@src/data/sounds.ts
@src/components/SoundCard.tsx
@app/(tabs)/index.tsx
@app/(tabs)/favorites.tsx
@app/(tabs)/settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mark premium sounds in catalog, build LockBadge + PremiumGate, create openPaywall helper</name>
  <files>
    src/data/sounds.ts
    src/components/LockBadge.tsx
    src/components/PremiumGate.tsx
    src/services/PremiumPaywallService.ts
  </files>
  <action>
**Step 1 — Update src/data/sounds.ts:**

Read the current `src/data/sounds.ts` (established in Phase 3 — 17 sounds across 4 categories). The `isPremium` field already exists but is `false` for all sounds. Update at least 4 sounds (from different categories) to have `isPremium: true`. These are the premium-locked catalog entries.

Set approximately 30-40% of sounds to premium. Choose 1-2 per category so each category has both free and premium options. For example:
- `rain-02` (Heavy Rain) → `isPremium: true`
- `fire-02` (Campfire / Deep Fire) → `isPremium: true`
- `forest-02` (Deep Forest) → `isPremium: true`
- `wave-02` (or equivalent second ocean sound) → `isPremium: true`

Read the actual sound IDs from the file before editing — match the existing structure exactly.

**Step 2 — Create src/components/LockBadge.tsx:**

Clean, modern lock indicator for a calm ambient app. Design: small icon + "Premium" text, positioned absolute top-right corner of the card, subtle dark background.

```typescript
// src/components/LockBadge.tsx
// Lock badge for premium sound cards.
// Claude's discretion: icon + "Premium" text (not icon-only).
// At small card sizes, icon-only can be confused with other status indicators.
// Design: subtle, non-distracting — consistent with calm aesthetic.

import { View, Text, StyleSheet } from 'react-native';
import { Ionicons } from '@expo/vector-icons';

export function LockBadge() {
  return (
    <View style={styles.badge}>
      <Ionicons name="lock-closed" size={10} color="rgba(255,255,255,0.90)" />
      <Text style={styles.label}>Premium</Text>
    </View>
  );
}

const styles = StyleSheet.create({
  badge: {
    position: 'absolute',
    top: 8,
    right: 8,
    flexDirection: 'row',
    alignItems: 'center',
    gap: 3,
    backgroundColor: 'rgba(0,0,0,0.50)',
    paddingHorizontal: 7,
    paddingVertical: 3,
    borderRadius: 6,
  },
  label: {
    color: 'rgba(255,255,255,0.90)',
    fontSize: 9,
    fontWeight: '600',
    letterSpacing: 0.3,
  },
});
```

**Step 3 — Create src/components/PremiumGate.tsx:**

Wrapper component: renders children normally for premium users; for free users wraps in a Pressable that calls `onLockedPress` and overlays `LockBadge`.

```typescript
// src/components/PremiumGate.tsx
// Premium access gate wrapper.
// Premium user: children render as-is with no lock UI.
// Free user: children wrapped in Pressable (calls onLockedPress), LockBadge overlaid.
//
// Usage:
//   <PremiumGate onLockedPress={openPaywall} enabled={sound.isPremium}>
//     <SoundCard ... />
//   </PremiumGate>

import { Pressable } from 'react-native';
import { useAuthStore } from '@/src/stores/authStore';
import { LockBadge } from './LockBadge';

interface PremiumGateProps {
  children: React.ReactNode;
  onLockedPress: () => void; // Called when a free user taps
  enabled: boolean; // true = this item requires premium; false = gate is inactive
}

export function PremiumGate({ children, onLockedPress, enabled }: PremiumGateProps) {
  const isPremium = useAuthStore((s) => s.isPremium);

  // Gate inactive or user is premium — render normally
  if (!enabled || isPremium) {
    return <>{children}</>;
  }

  // Free user accessing a premium item — wrap in pressable, add lock badge
  return (
    <Pressable onPress={onLockedPress} style={{ position: 'relative' }}>
      {children}
      <LockBadge />
    </Pressable>
  );
}
```

**Step 4 — Create src/services/PremiumPaywallService.ts:**

The `openPaywall()` function is the single callsite for presenting the RevenueCat native paywall. It centralizes the fullscreen guard, PAYWALL_RESULT handling, error messaging, and active playback rule.

```typescript
// src/services/PremiumPaywallService.ts
// Central helper for presenting the RevenueCat native paywall.
//
// Guards:
//   1. LOCKED DECISION: Never show during fullscreen immersive mode
//   2. CLAUDE'S DISCRETION: During active playback on regular player screen,
//      do not interrupt — show paywall only when not playing, or when user
//      navigates away from the player context. Rationale: calm experience first.
//      If audio is playing, the paywall still opens (not blocked) — the "no
//      interruption" rule applies only to the fullscreen immersive mode per the
//      locked decision; during regular player view, the paywall can open.
//
// PAYWALL_RESULT handling (locked decisions):
//   PURCHASED / RESTORED → no celebration, sounds just unlock (isPremium updates via listener)
//   CANCELLED → Alert: "Purchase didn't complete. Try again." (locked decision: cancellation = same message as failure)
//   ERROR → Alert: "Purchase didn't complete. Try again."
//   NOT_PRESENTED → dev warning only (offering not configured in RC dashboard)
//
// Restore purchases is available on the RevenueCat native paywall by default.
// restorePurchases() is also exported for the Settings screen row.

import RevenueCatUI, { PAYWALL_RESULT } from 'react-native-purchases-ui';
import Purchases from 'react-native-purchases';
import { Alert } from 'react-native';
import { useUIStore } from '@/src/stores/uiStore';

/**
 * Opens the RevenueCat native paywall.
 * Guards: fullscreen immersive mode (blocked per locked decision).
 * Call from any screen or component when a free user taps a premium-locked element.
 */
export async function openPaywall(): Promise<void> {
  // LOCKED DECISION: Never show paywall during fullscreen immersive mode
  const isImmersive = useUIStore.getState().isImmersiveMode;
  if (isImmersive) {
    // Silently return — do not interrupt the immersive experience
    return;
  }

  try {
    // LOCKED DECISION: RevenueCat default template — no custom paywall screen
    const result: PAYWALL_RESULT = await RevenueCatUI.presentPaywall();

    switch (result) {
      case PAYWALL_RESULT.PURCHASED:
      case PAYWALL_RESULT.RESTORED:
        // isPremium already updated by addCustomerInfoUpdateListener in usePremiumStatus.
        // LOCKED DECISION: No celebration screen or animation — sounds just unlock.
        break;

      case PAYWALL_RESULT.CANCELLED:
        // LOCKED DECISION: Show same error message on cancellation
        // CONTEXT.md: "failure or cancellation: show error message"
        Alert.alert(
          'Purchase Failed',
          "Purchase didn't complete. Try again.",
          [{ text: 'OK' }]
        );
        break;

      case PAYWALL_RESULT.ERROR:
        // LOCKED DECISION: Show brief error message then dismiss
        Alert.alert(
          'Purchase Failed',
          "Purchase didn't complete. Try again.",
          [{ text: 'OK' }]
        );
        break;

      case PAYWALL_RESULT.NOT_PRESENTED:
        // RevenueCat dashboard offering not configured — development/setup issue
        console.warn('[PremiumPaywallService] Paywall not presented: no offering configured in RevenueCat dashboard');
        break;
    }
  } catch (error) {
    console.warn('[PremiumPaywallService] presentPaywall threw unexpectedly:', error);
    Alert.alert('Purchase Failed', "Purchase didn't complete. Try again.", [{ text: 'OK' }]);
  }
}

/**
 * Restores previous purchases. Call from the Settings screen "Restore Purchases" row.
 * RevenueCat native paywall also includes restore — this is for the settings surface.
 * LOCKED DECISION: Restore purchases accessible from Settings screen.
 */
export async function restorePurchases(): Promise<void> {
  try {
    await Purchases.restorePurchases();
    // isPremium updates via addCustomerInfoUpdateListener if a subscription is restored
    Alert.alert('Purchases Restored', 'Your subscription has been restored.');
  } catch (error) {
    console.warn('[PremiumPaywallService] restorePurchases failed:', error);
    Alert.alert('Restore Failed', "Couldn't restore purchases. Try again.");
  }
}
```
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

    # TypeScript check
    npx tsc --noEmit 2>&1 | head -30

    # Verify at least 4 premium sounds in catalog
    grep -c "isPremium: true" src/data/sounds.ts
    # Expected: >= 4

    # Verify LockBadge exports
    grep "export function LockBadge" src/components/LockBadge.tsx

    # Verify PremiumGate exports and uses authStore.isPremium
    grep "export function PremiumGate" src/components/PremiumGate.tsx
    grep "isPremium" src/components/PremiumGate.tsx

    # Verify openPaywall guards fullscreen immersive mode
    grep "isImmersiveMode\|isImmersive" src/services/PremiumPaywallService.ts

    # Verify RevenueCat UI is used (not custom paywall)
    grep "presentPaywall\|RevenueCatUI" src/services/PremiumPaywallService.ts

    # Verify PAYWALL_RESULT cases handled
    grep "PURCHASED\|RESTORED\|CANCELLED\|ERROR\|NOT_PRESENTED" src/services/PremiumPaywallService.ts

    # Verify error message matches locked decision
    grep "Purchase didn't complete" src/services/PremiumPaywallService.ts

    # Verify restorePurchases exported
    grep "export async function restorePurchases" src/services/PremiumPaywallService.ts
    ```
    TypeScript must pass with 0 errors. All grep checks return matches.
  </verify>
  <done>
    - `src/data/sounds.ts` has at least 4 sounds with `isPremium: true` (spread across categories)
    - `LockBadge` exported: absolute positioned top-right, lock icon + "Premium" text, subtle dark background
    - `PremiumGate` exported: reads `authStore.isPremium`; premium users see children directly; free users see children wrapped in Pressable + LockBadge
    - `openPaywall()` exported: guards `isImmersiveMode` (locked decision), presents `RevenueCatUI.presentPaywall()`, handles all PAYWALL_RESULT cases with correct locked-decision behavior
    - Both CANCELLED and ERROR show `Alert.alert('Purchase Failed', "Purchase didn't complete. Try again.", [{ text: 'OK' }])` — same message for both (locked decision: failure or cancellation = show error message)
    - `restorePurchases()` exported for Settings screen
    - TypeScript passes with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire lock indicators and paywall entry points into library, favorites, and settings screens</name>
  <files>
    src/components/FavoriteButton.tsx
    src/components/SoundCard.tsx
    app/(tabs)/index.tsx
    app/(tabs)/favorites.tsx
    app/(tabs)/settings.tsx
  </files>
  <action>
Read all four files before editing. Make targeted additions — do not rewrite existing logic.

**src/components/SoundCard.tsx — Add premium support:**

Read the current SoundCard. It already has `isPremium` in the sound data (Phase 3 added a PRO/lock badge placeholder). Replace the placeholder badge with `LockBadge` when `sound.isPremium && !isPremium` (free user viewing premium sound).

The card itself should NOT intercept taps — that is the `PremiumGate` wrapper's responsibility. SoundCard remains a pure display component. Its existing `onPress` prop continues to work normally.

```typescript
// ADD to SoundCard imports:
import { LockBadge } from './LockBadge';
import { useAuthStore } from '@/src/stores/authStore';

// ADD inside SoundCard component body:
const isPremium = useAuthStore((s) => s.isPremium);

// REPLACE existing PRO/lock badge placeholder with:
// Render LockBadge only when sound is premium AND user is not a subscriber
{sound.isPremium && !isPremium && <LockBadge />}
```

Remove any previous Phase 3 "PRO pill" or static lock badge placeholder — LockBadge replaces it.

**app/(tabs)/index.tsx — Premium gates on sound cards + library banner:**

Read the current library screen. Sound cards are rendered inside `CategorySection → SoundCard`. Wrap each SoundCard's tap handler in a premium gate.

Specifically:
1. When a sound card is tapped: if `sound.isPremium && !isPremium` → call `openPaywall()` instead of navigating to player.
2. Add a subtle banner row at the top of the library screen (above category sections) for free users — visible only when `!isPremium`. The banner says "Unlock all sounds — Go Premium" with a short subtitle. Tapping calls `openPaywall()`.

```typescript
// ADD to imports:
import { openPaywall } from '@/src/services/PremiumPaywallService';
import { useAuthStore } from '@/src/stores/authStore';
import { PremiumGate } from '@/src/components/PremiumGate';

// ADD in component body:
const isPremium = useAuthStore((s) => s.isPremium);

// MODIFY sound card tap logic (existing onPress or navigation call):
// Before navigating to player, check:
const handleSoundPress = (sound: SoundConfig) => {
  if (sound.isPremium && !isPremium) {
    openPaywall();
    return;
  }
  // existing navigation to player
  router.push({ pathname: '/player', params: { soundId: sound.id } });
  // (adjust to match actual navigation pattern in the file)
};

// ADD premium banner (rendered before the category FlatList, visible only when !isPremium):
// Use a simple Pressable row with a lock icon, "Go Premium" title, short subtitle
// Tapping it calls openPaywall()
// Keep it subtle and non-intrusive — one row, not a full-screen interstitial
```

For the favorite button on sound cards: the favorite toggle is in `src/components/FavoriteButton.tsx` (created in Phase 4, Plan 04-02). It receives a `soundId` prop and calls `toggleFavorite` from `favoritesStore`. Add a `sound` prop (or `isPremiumSound: boolean` prop) to `FavoriteButton` so it can check if the sound is premium. When a free user taps the favorite button on a premium sound, call `openPaywall()` instead of `toggleFavorite`. The check is: `if (isPremiumSound && !isPremium) { openPaywall(); return; }` before the toggle logic.

Update `src/components/FavoriteButton.tsx`:
- Add `isPremiumSound?: boolean` to the component props interface (default: false for backward compatibility)
- Import `openPaywall` from `@/src/services/PremiumPaywallService`
- Import `useAuthStore` from `@/src/stores/authStore`
- At the top of the press handler, add the premium gate check before calling `toggleFavorite`

Update `src/components/SoundCard.tsx` (which renders `FavoriteButton`):
- Pass `isPremiumSound={sound.isPremium}` to the `FavoriteButton` component

**app/(tabs)/favorites.tsx — Subscription nudge for free users:**

Read the current favorites screen. Add a subtle nudge row at the top of the screen (above the favorites list) that appears only when `!isPremium`. The nudge should be a single row: a star/sparkle icon, "Subscribe to unlock premium sounds", and a small "Learn More" link. Tapping it calls `openPaywall()`. This row should not disrupt the existing favorites list layout.

```typescript
// ADD to imports:
import { openPaywall } from '@/src/services/PremiumPaywallService';
import { useAuthStore } from '@/src/stores/authStore';

// ADD in component:
const isPremium = useAuthStore((s) => s.isPremium);

// ADD nudge row at top of screen (before favorites list):
{!isPremium && (
  <Pressable onPress={openPaywall} style={styles.premiumNudge}>
    <Ionicons name="star" size={14} color="#f59e0b" />
    <Text style={styles.nudgeText}>Subscribe to unlock premium sounds</Text>
    <Text style={styles.nudgeLink}>Learn More</Text>
  </Pressable>
)}
// Add nudge styles: horizontal row, amber star, subtle background, compact height (~44pt)
```

**app/(tabs)/settings.tsx — Restore Purchases row + premium entry point:**

Read the current settings screen. Add two new rows:

1. "Restore Purchases" row — visible to all users (both free and premium). Calls `restorePurchases()` from `PremiumPaywallService`. Place it near the bottom of the settings list.

2. "Go Premium" / premium subscription entry row — visible only when `!isPremium`. Shows a brief description ("Unlock all sounds, Infinity mode, custom timer") and a "Subscribe" button. Tapping calls `openPaywall()`. Place it at a prominent position (top of settings or in its own section).

```typescript
// ADD to imports:
import { openPaywall, restorePurchases } from '@/src/services/PremiumPaywallService';
import { useAuthStore } from '@/src/stores/authStore';

// ADD in component:
const isPremium = useAuthStore((s) => s.isPremium);

// Premium entry row (only for free users):
{!isPremium && (
  <Pressable onPress={openPaywall} style={styles.premiumRow}>
    <View>
      <Text style={styles.premiumTitle}>Go Premium</Text>
      <Text style={styles.premiumSub}>Unlock all sounds, Infinity mode, custom timer</Text>
    </View>
    <Ionicons name="chevron-forward" size={18} color="rgba(255,255,255,0.4)" />
  </Pressable>
)}

// Restore Purchases row (visible to all):
<Pressable onPress={restorePurchases} style={styles.settingsRow}>
  <Text style={styles.settingsRowText}>Restore Purchases</Text>
</Pressable>
```

Add styles for the new rows. Keep them consistent with existing settings screen styling — the overall design direction is calm and dark.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

    # TypeScript check
    npx tsc --noEmit 2>&1 | head -30

    # Verify LockBadge used in SoundCard
    grep "LockBadge" src/components/SoundCard.tsx

    # Verify premium check in SoundCard
    grep "isPremium" src/components/SoundCard.tsx

    # Verify openPaywall imported in library
    grep "openPaywall" app/\(tabs\)/index.tsx

    # Verify PremiumGate or isPremium guard on sound card tap in library
    grep "isPremium\|PremiumGate\|openPaywall" app/\(tabs\)/index.tsx | head -5

    # Verify premium banner in library
    grep "Go Premium\|openPaywall" app/\(tabs\)/index.tsx

    # Verify subscription nudge in Favorites
    grep "openPaywall\|isPremium" app/\(tabs\)/favorites.tsx

    # Verify Restore Purchases in Settings
    grep "restorePurchases\|Restore" app/\(tabs\)/settings.tsx

    # Verify premium entry in Settings
    grep "Go Premium\|openPaywall\|isPremium" app/\(tabs\)/settings.tsx
    ```
    TypeScript must pass with 0 errors. All grep checks return matches.
  </verify>
  <done>
    - `SoundCard` shows `LockBadge` when `sound.isPremium && !userIsPremium`
    - Library screen: tapping a premium sound card calls `openPaywall()` instead of navigating to player
    - Library screen: premium banner row visible for free users (`!isPremium`), calls `openPaywall()` on tap
    - Favorites screen: subscription nudge row visible for free users, calls `openPaywall()` on tap
    - Settings screen: "Restore Purchases" row visible to all users, calls `restorePurchases()` on tap
    - Settings screen: "Go Premium" entry row visible for free users (`!isPremium`), calls `openPaywall()` on tap
    - Tapping favorite button on a premium sound (when free user) calls `openPaywall()` instead of favoriting
    - TypeScript passes with 0 errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify paywall flow end-to-end on real device</name>
  <files>app/(tabs)/index.tsx</files>
  <action>
    Human verification of RevenueCat paywall flow on real device. No code changes — validate what was built.
    Prerequisites: RevenueCat dashboard configured (entitlement 'premium', products, Default Offering), env vars set, EAS Development Build rebuilt with react-native-purchases.
  </action>
  <what-built>
    RevenueCat SDK integrated (Plans 06-01 + 06-02), premium lock indicators on sound cards, paywall routing from all entry points (library card, library banner, favorites nudge, settings), restore purchases in settings.
  </what-built>
  <how-to-verify>
    Complete these steps on a real iOS or Android device (Development Build — not Expo Go):

    **Prerequisites (manual setup required before this checkpoint):**
    1. Ensure RevenueCat dashboard has entitlement named exactly 'premium', at least one product configured, and a Default Offering set up
    2. Ensure EXPO_PUBLIC_RC_APPLE_API_KEY (iOS) or EXPO_PUBLIC_RC_GOOGLE_API_KEY (Android) is set in your .env.local
    3. Rebuild the EAS Development Build after react-native-purchases install: `eas build --platform ios --profile development`

    **Verification steps:**
    1. Launch the app. Open the library screen.
    2. Confirm premium sounds have a lock badge visible in the top-right corner of their card.
    3. Tap a premium sound card — the RevenueCat paywall should appear immediately (no preview).
    4. Dismiss the paywall by tapping Cancel or outside it.
    5. Tap the favorite button on a premium sound — the paywall should appear instead of favoriting.
    6. Enter fullscreen immersive mode (tap fullscreen button on player). Then try to open a paywall entry point from another tab if reachable — paywall should NOT appear.
    7. Open the Favorites tab — confirm the subscription nudge row appears at the top.
    8. Tap the nudge — paywall should open.
    9. Open Settings — confirm "Restore Purchases" row and "Go Premium" section visible.
    10. In RevenueCat sandbox mode, complete a test purchase (iOS: use Sandbox Tester account; Android: use internal testing track). After purchase: paywall dismisses, premium sounds unlock immediately (no restart). Lock badges disappear on premium cards.
    11. Confirm no "celebration screen" — sounds just work after purchase.
    12. Tap "Restore Purchases" in Settings — should restore the subscription if already purchased.
  </how-to-verify>
  <verify>Human approves all 12 verification steps above.</verify>
  <done>Paywall flow verified end-to-end: lock badges visible, paywall opens correctly from all entry points, purchase unlocks content immediately, fullscreen guard works, restore purchases works.</done>
  <resume-signal>Type "approved" if paywall flow works end-to-end, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete and checkpoint approved:

```bash
cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

# Full TypeScript check
npx tsc --noEmit
# Expected: 0 errors

# Premium sounds in catalog
grep -c "isPremium: true" src/data/sounds.ts
# Expected: >= 4

# LockBadge component
grep "export function LockBadge" src/components/LockBadge.tsx

# PremiumGate component
grep "export function PremiumGate\|isPremium\|LockBadge" src/components/PremiumGate.tsx

# openPaywall: fullscreen guard present
grep "isImmersiveMode\|isImmersive" src/services/PremiumPaywallService.ts

# openPaywall: error message exact match
grep "Purchase didn't complete. Try again" src/services/PremiumPaywallService.ts

# Screen integrations
grep "openPaywall" app/\(tabs\)/index.tsx
grep "openPaywall" app/\(tabs\)/favorites.tsx
grep "restorePurchases" app/\(tabs\)/settings.tsx
```
</verification>

<success_criteria>
- At least 4 sounds in `src/data/sounds.ts` have `isPremium: true`
- `LockBadge` component: lock icon + "Premium" text, absolute top-right, subtle dark pill
- `PremiumGate` wrapper: gates children behind `authStore.isPremium`
- `openPaywall()` guards fullscreen immersive mode, uses `RevenueCatUI.presentPaywall()`, handles all PAYWALL_RESULT cases with locked-decision behavior — both CANCELLED and ERROR show the error message
- `restorePurchases()` available for Settings screen
- Library screen: premium sound cards show lock badge; tapping opens paywall; premium banner for free users
- Favorites screen: subscription nudge for free users
- Settings screen: Restore Purchases row + Go Premium entry for free users
- Human checkpoint approved: purchase flow works end-to-end on device
- `npx tsc --noEmit` exits 0 across all modified files
</success_criteria>

<output>
After completion and checkpoint approval, create `.planning/phases/06-freemium-and-monetization/06-02-SUMMARY.md` documenting:
- How many sounds were marked premium and which IDs
- LockBadge: final design choices (position, colors, text)
- PremiumGate: actual implementation vs plan (any deviations)
- openPaywall: fullscreen guard — which store field / property was used for isImmersiveMode
- FavoriteButton: where the premium check was inserted (SoundCard, FavoriteButton component, or screen level)
- Library banner: final UI implementation
- Favorites nudge: final UI implementation
- Settings: Restore Purchases placement and Go Premium section placement
- RevenueCat dashboard configuration that was completed
- Sandbox purchase test: result and any issues encountered
</output>
