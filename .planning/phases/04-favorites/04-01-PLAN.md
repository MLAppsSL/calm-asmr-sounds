---
phase: 04-favorites
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/favoritesStore.ts
  - src/stores/uiStore.ts
  - src/types/index.ts
  - src/services/LocalFavoritesAdapter.ts
  - package.json
autonomous: true
requirements:
  - FAV-01
  - FAV-02
  - SET-02

must_haves:
  truths:
    - "favoritesStore holds favorites as Favorite[] with addedAt timestamps — not string[]"
    - "favoritesStore persists to AsyncStorage via Zustand persist middleware and survives app restarts"
    - "favoritesStore's _hasHydrated flag is false on cold start and becomes true after AsyncStorage rehydrates"
    - "uiStore exposes defaultTimerDuration (TimerDuration) and setDefaultTimerDuration — both persisted to AsyncStorage"
    - "uiStore isDarkMode initializes from Appearance.getColorScheme() when no persisted value exists (not hardcoded true)"
    - "LocalFavoritesAdapter provides a class-based interface over favoritesStore for Phase 5 migration"
  artifacts:
    - path: "src/stores/favoritesStore.ts"
      provides: "Zustand persist store: favorites Favorite[], _hasHydrated, toggleFavorite, isFavorite, setFavorites, getSortedFavorites"
      exports: ["useFavoritesStore", "Favorite"]
      min_lines: 50
    - path: "src/stores/uiStore.ts"
      provides: "Zustand persist store upgraded: defaultTimerDuration: TimerDuration, setDefaultTimerDuration, isDarkMode uses Appearance.getColorScheme() as fallback"
      exports: ["useUIStore"]
    - path: "src/types/index.ts"
      provides: "Favorite interface added: { id: string; addedAt: number }"
    - path: "src/services/LocalFavoritesAdapter.ts"
      provides: "Class adapter over favoritesStore: getFavorites, addFavorite, removeFavorite, setFavorites"
      exports: ["LocalFavoritesAdapter"]
  key_links:
    - from: "src/stores/favoritesStore.ts"
      to: "@react-native-async-storage/async-storage"
      via: "createJSONStorage(() => AsyncStorage) in persist options"
      pattern: "createJSONStorage"
    - from: "src/stores/favoritesStore.ts"
      to: "onRehydrateStorage callback"
      via: "state?.setHasHydrated(true)"
      pattern: "setHasHydrated"
    - from: "src/stores/uiStore.ts"
      to: "Appearance.getColorScheme()"
      via: "isDarkMode initial value fallback (synchronous, module-init time)"
      pattern: "getColorScheme"
    - from: "src/services/LocalFavoritesAdapter.ts"
      to: "src/stores/favoritesStore.ts"
      via: "useFavoritesStore.getState()"
      pattern: "useFavoritesStore\\.getState"
---

<objective>
Upgrade the Phase 1 favoritesStore scaffold to a production-ready persisted store, add defaultTimerDuration to uiStore, and create the LocalFavoritesAdapter interface that Phase 5's cloud migration will depend on.

Purpose: This plan establishes the data layer that Plans 04-02 and 04-03 will build UI on top of. The favoritesStore upgrade (string[] → Favorite[] with persist) is the only breaking change in Phase 4 — it must land first.
Output: Upgraded favoritesStore with persist, upgraded uiStore with defaultTimerDuration + system dark mode default, LocalFavoritesAdapter service.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-favorites/04-RESEARCH.md
@src/stores/favoritesStore.ts
@src/stores/uiStore.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-system-ui and upgrade favoritesStore to persisted Favorite[] structure</name>
  <files>
    package.json
    src/types/index.ts
    src/stores/favoritesStore.ts
  </files>
  <action>
1. Install expo-system-ui (required for Android dark mode system preference support in EAS builds):
   ```bash
   npx expo install expo-system-ui
   ```

2. Add the `Favorite` interface to `src/types/index.ts`. This is a BREAKING CHANGE from Phase 1's `string[]`-based favorites. Add after the existing type definitions:

   ```typescript
   export interface Favorite {
     id: string;       // sound ID
     addedAt: number;  // Date.now() timestamp — enables most-recently-added ordering and Phase 5 migration
   }
   ```

3. Replace `src/stores/favoritesStore.ts` entirely. The Phase 1 scaffold (`favoriteIds: string[]`, plain store without persist) must be replaced with the production version. Key changes:
   - State field: `favoriteIds: string[]` → `favorites: Favorite[]`
   - New field: `_hasHydrated: boolean` (false on cold start, true after AsyncStorage loads)
   - New action: `toggleFavorite(id: string)` — combines addFavorite/removeFavorite into one toggle
   - New action: `setHasHydrated(v: boolean)` — called by `onRehydrateStorage`
   - New selector: `getSortedFavorites()` — returns `[...favorites].sort((a, b) => b.addedAt - a.addedAt)` (most recently added first)
   - Updated `setFavorites` signature: `setFavorites(favorites: Favorite[])` — BREAKING CHANGE from `setFavorites(ids: string[])`
   - `isFavorite(id: string)` — uses `favorites.some(f => f.id === id)` instead of `favoriteIds.includes(id)`
   - Zustand `persist` middleware with `createJSONStorage(() => AsyncStorage)`, `partialize: (s) => ({ favorites: s.favorites })` (DO NOT persist `_hasHydrated`), `onRehydrateStorage: () => (state) => state?.setHasHydrated(true)`

   ```typescript
   // src/stores/favoritesStore.ts
   // Phase 4 upgrade: string[] → Favorite[] with persist middleware and ordering.
   // Breaking change: setFavorites now accepts Favorite[] not string[].
   // Phase 5 FavoritesService.migrateLocalToCloud depends on Favorite[] type.
   import { create } from 'zustand';
   import { persist, createJSONStorage } from 'zustand/middleware';
   import AsyncStorage from '@react-native-async-storage/async-storage';
   import type { Favorite } from '../types';

   interface FavoritesState {
     favorites: Favorite[];
     _hasHydrated: boolean;
     toggleFavorite: (id: string) => void;
     isFavorite: (id: string) => boolean;
     setFavorites: (favorites: Favorite[]) => void;
     setHasHydrated: (v: boolean) => void;
     getSortedFavorites: () => Favorite[];
   }

   export const useFavoritesStore = create<FavoritesState>()(
     persist(
       (set, get) => ({
         favorites: [],
         _hasHydrated: false,
         toggleFavorite: (id) =>
           set((state) => {
             const exists = state.favorites.some((f) => f.id === id);
             return {
               favorites: exists
                 ? state.favorites.filter((f) => f.id !== id)
                 : [...state.favorites, { id, addedAt: Date.now() }],
             };
           }),
         isFavorite: (id) => get().favorites.some((f) => f.id === id),
         setFavorites: (favorites) => set({ favorites }),
         setHasHydrated: (v) => set({ _hasHydrated: v }),
         getSortedFavorites: () =>
           [...get().favorites].sort((a, b) => b.addedAt - a.addedAt),
       }),
       {
         name: 'favorites-storage',
         storage: createJSONStorage(() => AsyncStorage),
         // IMPORTANT: only persist favorites, never _hasHydrated (it's ephemeral session state)
         partialize: (s) => ({ favorites: s.favorites }),
         onRehydrateStorage: () => (state) => state?.setHasHydrated(true),
       }
     )
   );
   ```

   After writing the file, check if any existing code in the project references `favoriteIds`, `addFavorite`, or `removeFavorite` from the old store shape. Run:
   ```bash
   grep -rn "favoriteIds\|addFavorite\|removeFavorite" src/ app/ --include="*.ts" --include="*.tsx"
   ```
   If found, update those callers to use `favorites`, `toggleFavorite`, and `isFavorite` from the new store.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    # TypeScript check
    npx tsc --noEmit 2>&1 | head -30

    # Verify expo-system-ui installed
    grep "expo-system-ui" package.json

    # Verify Favorite interface in types
    grep "interface Favorite" src/types/index.ts

    # Verify persist middleware in favoritesStore
    grep "persist\|createJSONStorage\|partialize\|onRehydrateStorage" src/stores/favoritesStore.ts

    # Verify no old string[] shape remains
    grep "favoriteIds" src/stores/favoritesStore.ts && echo "ERROR: old shape found" || echo "OK: clean"

    # Verify _hasHydrated is NOT in partialize (only favorites is)
    grep "partialize" src/stores/favoritesStore.ts
    # Expected output: partialize: (s) => ({ favorites: s.favorites })
    ```
    TypeScript must pass with 0 errors. All grep checks must match expectations.
  </verify>
  <done>
    - `expo-system-ui` added to package.json
    - `Favorite` interface exported from `src/types/index.ts` with `id: string` and `addedAt: number`
    - `src/stores/favoritesStore.ts` uses `favorites: Favorite[]` (not `favoriteIds: string[]`)
    - `persist` middleware configured with AsyncStorage, `partialize` persisting only `favorites`
    - `_hasHydrated: false` in initial state, set to `true` via `onRehydrateStorage` callback
    - `toggleFavorite`, `isFavorite`, `setFavorites(Favorite[])`, `getSortedFavorites` all present
    - No TypeScript errors across the project
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade uiStore with defaultTimerDuration and system dark mode initialization</name>
  <files>
    src/stores/uiStore.ts
  </files>
  <action>
Upgrade `src/stores/uiStore.ts` to add `defaultTimerDuration` and change `isDarkMode` initialization. The Phase 3 version hardcoded `isDarkMode: true` — Phase 4 must use `Appearance.getColorScheme() === 'dark'` as the initial value when no persisted preference exists.

Read the current `src/stores/uiStore.ts` first, then apply these changes:

1. Add `import { Appearance } from 'react-native';` at the top

2. Add `defaultTimerDuration: TimerDuration` field to the state interface with `setDefaultTimerDuration(duration: TimerDuration) => void` action

3. Change the `isDarkMode` initial value from `true` to `Appearance.getColorScheme() === 'dark'`. This is called synchronously at module initialization time — safe per the React Native Appearance API.

4. Update the `partialize` function to also persist `defaultTimerDuration`:
   ```typescript
   partialize: (s) => ({ isDarkMode: s.isDarkMode, defaultTimerDuration: s.defaultTimerDuration }),
   ```

5. Add `import type { TimerDuration } from '../types';` to the imports

The complete upgraded additions (read current file first, then merge these in):

```typescript
// Add to imports:
import { Appearance } from 'react-native';
import type { TimerDuration } from '../types';

// Add to UIState interface:
defaultTimerDuration: TimerDuration;
setDefaultTimerDuration: (duration: TimerDuration) => void;

// Change isDarkMode initial value:
isDarkMode: Appearance.getColorScheme() === 'dark',  // was: isDarkMode: true

// Add to store actions (set object):
defaultTimerDuration: 60 as TimerDuration,  // 1 minute default (safest for free tier)
setDefaultTimerDuration: (duration) => set({ defaultTimerDuration: duration }),

// Update partialize:
partialize: (s) => ({ isDarkMode: s.isDarkMode, defaultTimerDuration: s.defaultTimerDuration }),
```

IMPORTANT: Do NOT change the `_hasHydrated` guard, `toggleDarkMode`, `isFullscreen`, `setFullscreen`, or `setHasHydrated` — these are Phase 3 additions that must be preserved exactly. Only add the two new fields and change the `isDarkMode` initial value and `partialize`.

Note: The dark mode change means that on first install (no persisted value), the app respects the device's system preference. On subsequent launches, the persisted value (from the user's previous toggle in Settings) overrides the system reading.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    # TypeScript check
    npx tsc --noEmit 2>&1 | head -30

    # Verify system preference initialization
    grep "Appearance.getColorScheme" src/stores/uiStore.ts

    # Verify defaultTimerDuration field exists
    grep "defaultTimerDuration" src/stores/uiStore.ts

    # Verify setDefaultTimerDuration action exists
    grep "setDefaultTimerDuration" src/stores/uiStore.ts

    # Verify partialize includes both fields
    grep "partialize" src/stores/uiStore.ts
    # Expected: partialize: (s) => ({ isDarkMode: s.isDarkMode, defaultTimerDuration: s.defaultTimerDuration })

    # Verify old hardcoded true is gone
    grep "isDarkMode: true" src/stores/uiStore.ts && echo "WARNING: hardcoded true still present" || echo "OK: uses Appearance"
    ```
    TypeScript must pass. All greps must match expectations.
  </verify>
  <done>
    - `uiStore` imports `Appearance` from react-native and `TimerDuration` from types
    - `isDarkMode` initial value is `Appearance.getColorScheme() === 'dark'` (not hardcoded `true`)
    - `defaultTimerDuration: 60 as TimerDuration` in initial state
    - `setDefaultTimerDuration(duration: TimerDuration)` action present
    - `partialize` persists both `isDarkMode` and `defaultTimerDuration`
    - All Phase 3 additions (_hasHydrated, toggleDarkMode, isFullscreen) preserved unchanged
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create LocalFavoritesAdapter for Phase 5 migration interface</name>
  <files>
    src/services/LocalFavoritesAdapter.ts
  </files>
  <action>
Create `src/services/LocalFavoritesAdapter.ts`. This adapter provides a clean class-based interface over `useFavoritesStore` that Phase 5's `FavoritesService.migrateLocalToCloud` will consume. Building it in Phase 4 makes Phase 5 purely additive (a CloudFavoritesAdapter implementing the same interface).

Rules:
- All reads and writes go through `useFavoritesStore.getState()` — never directly through AsyncStorage
- Methods return Promises (async/await signature) even though the operations are synchronous — this makes the interface compatible with the Phase 5 CloudFavoritesAdapter (which will be async over Firestore)
- Do NOT import or call AsyncStorage directly in this file

```typescript
// src/services/LocalFavoritesAdapter.ts
//
// Wraps useFavoritesStore for Phase 5 migration compatibility.
// Phase 5 will create a CloudFavoritesAdapter implementing the same interface,
// then FavoritesService will swap adapters on sign-in.
//
// IMPORTANT: All methods go through the Zustand store — never direct AsyncStorage calls.
// The store handles persistence; the adapter just provides the interface.

import { useFavoritesStore } from '../stores/favoritesStore';
import type { Favorite } from '../types';

export class LocalFavoritesAdapter {
  /**
   * Returns all favorites sorted by most recently added first.
   * Synchronous read from Zustand store (already in memory after hydration).
   */
  getFavorites(): Favorite[] {
    return useFavoritesStore.getState().getSortedFavorites();
  }

  /**
   * Adds a sound to favorites. No-op if already a favorite (toggle semantics
   * are handled in the store — calling this when already favorited has no effect
   * because toggleFavorite checks existence first).
   */
  async addFavorite(id: string): Promise<void> {
    const { isFavorite, toggleFavorite } = useFavoritesStore.getState();
    if (!isFavorite(id)) {
      toggleFavorite(id);
    }
  }

  /**
   * Removes a sound from favorites. No-op if not currently a favorite.
   */
  async removeFavorite(id: string): Promise<void> {
    const { isFavorite, toggleFavorite } = useFavoritesStore.getState();
    if (isFavorite(id)) {
      toggleFavorite(id);
    }
  }

  /**
   * Replaces all favorites at once. Used by Phase 5 migration:
   * FavoritesService.migrateLocalToCloud reads local favorites via getFavorites(),
   * writes them to Firestore, then calls setFavorites([]) to clear local storage.
   */
  async setFavorites(favorites: Favorite[]): Promise<void> {
    useFavoritesStore.getState().setFavorites(favorites);
  }

  /**
   * Checks if a specific sound is favorited. Synchronous.
   */
  isFavorite(id: string): boolean {
    return useFavoritesStore.getState().isFavorite(id);
  }
}
```
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    # TypeScript check
    npx tsc --noEmit 2>&1 | head -30

    # Verify file exists with class export
    grep "export class LocalFavoritesAdapter" src/services/LocalFavoritesAdapter.ts

    # Verify no direct AsyncStorage imports (must go through store)
    grep "AsyncStorage" src/services/LocalFavoritesAdapter.ts && echo "ERROR: direct AsyncStorage use" || echo "OK"

    # Verify useFavoritesStore.getState() pattern
    grep "useFavoritesStore.getState" src/services/LocalFavoritesAdapter.ts

    # Verify async methods return Promise
    grep "async\|Promise" src/services/LocalFavoritesAdapter.ts
    ```
    TypeScript must pass. No direct AsyncStorage imports. getState() pattern used. Async methods present.
  </verify>
  <done>
    - `src/services/LocalFavoritesAdapter.ts` exports `LocalFavoritesAdapter` class
    - `getFavorites()` and `isFavorite()` are synchronous (return values directly)
    - `addFavorite`, `removeFavorite`, `setFavorites` are async (return Promise&lt;void&gt;)
    - All operations route through `useFavoritesStore.getState()` — no direct AsyncStorage
    - TypeScript passes with no errors
  </done>
</task>

</tasks>

<verification>
After all three tasks complete, verify the full plan outcome:

```bash
cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
# Full TypeScript check — must be clean
npx tsc --noEmit

# expo-system-ui installed
grep "expo-system-ui" package.json

# Favorite type in types
grep "Favorite" src/types/index.ts

# favoritesStore: new shape, persist, hydration guard
grep -n "Favorite\[\]\|_hasHydrated\|persist\|toggleFavorite\|getSortedFavorites" src/stores/favoritesStore.ts

# uiStore: system dark mode, defaultTimerDuration
grep -n "Appearance.getColorScheme\|defaultTimerDuration" src/stores/uiStore.ts

# LocalFavoritesAdapter: class exists, async interface
grep -n "class LocalFavoritesAdapter\|getFavorites\|addFavorite\|removeFavorite\|setFavorites" src/services/LocalFavoritesAdapter.ts

# No old favoriteIds references remain anywhere
grep -rn "favoriteIds" src/ app/ --include="*.ts" --include="*.tsx"
# Expected: 0 results (old field completely removed)
```
</verification>

<success_criteria>
- `Favorite` interface exported from `src/types/index.ts` with `id` and `addedAt` fields
- `useFavoritesStore` uses `favorites: Favorite[]` with Zustand `persist` + AsyncStorage — favorites survive app restarts
- `_hasHydrated: false` on cold start, `true` after AsyncStorage rehydration via `onRehydrateStorage`
- `uiStore.isDarkMode` initializes from `Appearance.getColorScheme()` (not hardcoded `true`)
- `uiStore.defaultTimerDuration` field exists, persisted, defaults to `60` (1 minute)
- `LocalFavoritesAdapter` provides async interface over the store for Phase 5 compatibility
- `npx tsc --noEmit` exits 0 across all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/04-favorites/04-01-SUMMARY.md` documenting:
- Favorite type shape and rationale for addedAt timestamp
- favoritesStore: what changed from Phase 1 scaffold and why (breaking changes)
- uiStore: what was added, what was changed (isDarkMode initialization)
- expo-system-ui: why installed, what it enables on Android
- LocalFavoritesAdapter: interface decisions (async signatures, getState() pattern)
- Any deviations from this plan and why
</output>
