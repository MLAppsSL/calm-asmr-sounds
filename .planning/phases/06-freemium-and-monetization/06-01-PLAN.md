---
phase: 06-freemium-and-monetization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/authStore.ts
  - src/services/PremiumService.ts
  - src/hooks/usePremiumStatus.ts
  - app/_layout.tsx
  - supabase/migrations/20260219000000_sounds_table_rls.sql
  - supabase/functions/revenuecat-webhook/index.ts
autonomous: true
requirements:
  - AUTH-04

user_setup:
  - service: revenuecat
    why: "RevenueCat must be configured with API keys and entitlement before SDK can be initialized"
    env_vars:
      - name: EXPO_PUBLIC_RC_APPLE_API_KEY
        source: "RevenueCat Dashboard → Apps → your iOS app → API Key"
      - name: EXPO_PUBLIC_RC_GOOGLE_API_KEY
        source: "RevenueCat Dashboard → Apps → your Android app → API Key"
      - name: REVENUECAT_WEBHOOK_SECRET
        source: "RevenueCat Dashboard → Integrations → Webhooks → Authorization Header value (set a long random string)"
    dashboard_config:
      - task: "Create entitlement named exactly 'premium' in RevenueCat dashboard"
        location: "RevenueCat Dashboard → Entitlements → + New"
      - task: "Set REVENUECAT_WEBHOOK_SECRET as a Supabase Edge Function secret"
        location: "Terminal: supabase secrets set REVENUECAT_WEBHOOK_SECRET=<your-value>"
  - service: supabase
    why: "Supabase migration must be applied and webhook Edge Function must be deployed"
    dashboard_config:
      - task: "Run migration to create sounds table and RLS policy"
        location: "Terminal: supabase db push (or apply migration in Supabase Studio SQL editor)"
      - task: "Deploy revenuecat-webhook Edge Function"
        location: "Terminal: supabase functions deploy revenuecat-webhook"
      - task: "Register Edge Function URL as RevenueCat webhook endpoint"
        location: "RevenueCat Dashboard → Integrations → Webhooks → Add Endpoint (URL: https://<project-ref>.supabase.co/functions/v1/revenuecat-webhook)"

must_haves:
  truths:
    - "authStore.isPremium is false by default and updates to true when RevenueCat confirms an active 'premium' entitlement"
    - "isPremium updates immediately after purchase with no app restart — addCustomerInfoUpdateListener fires before presentPaywall resolves"
    - "Purchases.configure() runs once at app startup before any auth state listener fires"
    - "Purchases.logIn(user.id) is called on every Supabase sign-in so RevenueCat and Supabase share the same user identity"
    - "Premium sound URLs are never returned by Supabase to a user whose JWT does not contain app_metadata.is_premium = true"
    - "The RevenueCat webhook Edge Function updates app_metadata.is_premium via the Supabase service role key"
    - "The webhook rejects requests without the correct Authorization header"
  artifacts:
    - path: "src/stores/authStore.ts"
      provides: "isPremium: boolean field + setIsPremium action added to existing authStore"
      contains: "isPremium"
    - path: "src/services/PremiumService.ts"
      provides: "PremiumService singleton — configure(), logIn(userId), logOut(), checkIsPremium(); wraps react-native-purchases"
      exports: ["PremiumService"]
    - path: "src/hooks/usePremiumStatus.ts"
      provides: "usePremiumStatus hook — initializes isPremium in authStore at startup; registers addCustomerInfoUpdateListener for real-time updates"
      exports: ["usePremiumStatus"]
    - path: "app/_layout.tsx"
      provides: "PremiumService.configure() called in root layout useEffect; usePremiumStatus() called in RootLayoutInner; Purchases.logIn called on Supabase auth change"
      contains: "PremiumService"
    - path: "supabase/migrations/20260219000000_sounds_table_rls.sql"
      provides: "sounds table with is_premium and url columns; RLS policy gating premium URL rows to app_metadata.is_premium users"
      contains: "CREATE POLICY"
    - path: "supabase/functions/revenuecat-webhook/index.ts"
      provides: "Edge Function receiving RevenueCat purchase events; updates Supabase user app_metadata.is_premium via service role key"
      min_lines: 50
  key_links:
    - from: "src/hooks/usePremiumStatus.ts"
      to: "src/stores/authStore.ts"
      via: "useAuthStore.getState().setIsPremium(isPremium) inside addCustomerInfoUpdateListener callback"
      pattern: "setIsPremium"
    - from: "src/hooks/usePremiumStatus.ts"
      to: "src/services/PremiumService.ts"
      via: "PremiumService.logIn(user.id) on Supabase auth change"
      pattern: "logIn"
    - from: "app/_layout.tsx"
      to: "src/hooks/usePremiumStatus.ts"
      via: "usePremiumStatus() call in RootLayoutInner — persists across all navigation"
      pattern: "usePremiumStatus"
    - from: "supabase/functions/revenuecat-webhook/index.ts"
      to: "supabase auth.admin"
      via: "supabaseAdmin.auth.admin.updateUserById(app_user_id, { app_metadata: { is_premium } })"
      pattern: "updateUserById"
    - from: "supabase/migrations/20260219000000_sounds_table_rls.sql"
      to: "auth.jwt()"
      via: "(auth.jwt() -> 'app_metadata' ->> 'is_premium')::boolean IS TRUE"
      pattern: "app_metadata"
---

<objective>
Install react-native-purchases + react-native-purchases-ui, add isPremium to authStore, create PremiumService and usePremiumStatus hook wired into the root layout, write the Supabase migration for the sounds table RLS policy, and create the RevenueCat webhook Edge Function.

Purpose: Every other Phase 6 plan reads authStore.isPremium. This plan establishes the authoritative premium state: RevenueCat entitlement on the client side and Supabase RLS on the server side. The webhook closes the loop so that app_metadata.is_premium reflects purchase state, enabling server-side URL gating that no client can bypass.

Output: Premium state flows end-to-end — from RevenueCat purchase → addCustomerInfoUpdateListener → authStore.isPremium → UI gates; and from RevenueCat webhook → Supabase app_metadata → RLS policy → premium URL gating.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-freemium-and-monetization/06-RESEARCH.md
@src/stores/authStore.ts
@app/_layout.tsx
@src/context/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-native-purchases packages, add isPremium to authStore, create PremiumService</name>
  <files>
    src/stores/authStore.ts
    src/services/PremiumService.ts
  </files>
  <action>
**Step 1 — Install packages:**

```bash
npx expo install react-native-purchases react-native-purchases-ui
```

Both packages must be the same version (9.10.1). After install, a new EAS Development Build is required for real purchase testing — native modules are not available in Expo Go. Do NOT rebuild here; flag it in a comment. The existing Development Build workflow from Phase 1 applies.

**Step 2 — Extend src/stores/authStore.ts:**

Read the current `src/stores/authStore.ts`. It was scaffolded in Phase 1 with `user: User | null` and `isLoading: boolean`. Phase 5 may have extended it further with Supabase User types. Read it first, then ADD the `isPremium` field without removing anything existing.

Add `isPremium: boolean` (default: false) and `setIsPremium: (value: boolean) => void` to the store interface and implementation:

```typescript
// ADD to AuthState interface:
isPremium: boolean;
setIsPremium: (value: boolean) => void;

// ADD to initial state object (set to false — default until RevenueCat confirms):
isPremium: false,

// ADD to store actions:
setIsPremium: (value) => set({ isPremium: value }),
```

Do not change any existing fields. If the existing store already has `isPremium`, read it and verify it has the `setIsPremium` action — only add what is missing.

**Step 3 — Create src/services/PremiumService.ts:**

This service wraps `react-native-purchases` to isolate RevenueCat calls from the rest of the app. It is the only file that imports from `react-native-purchases`.

```typescript
// src/services/PremiumService.ts
//
// RevenueCat SDK wrapper. The only file in the project that imports react-native-purchases.
//
// IMPORTANT: Call PremiumService.configure() ONCE at app startup — before any auth state
// listener runs. Call logIn(supabaseUserId) on every Supabase sign-in. Without logIn(),
// RevenueCat uses an anonymous ID that the webhook cannot match to a Supabase user.
//
// NOTE: A new EAS Development Build is required after installing react-native-purchases.
// RevenueCat runs in Preview API Mode (mocked) in Expo Go — real purchases require the build.

import Purchases, { LOG_LEVEL } from 'react-native-purchases';
import { Platform } from 'react-native';

class PremiumServiceClass {
  private configured = false;

  /**
   * Initializes the RevenueCat SDK.
   * Call once at app startup in the root layout useEffect.
   * Calling more than once throws — guarded by this.configured flag.
   */
  configure(): void {
    if (this.configured) return;
    this.configured = true;

    if (__DEV__) {
      Purchases.setLogLevel(LOG_LEVEL.DEBUG);
    }

    // Platform-specific API keys from env vars (set in .env.local / EAS Secrets)
    const apiKey =
      Platform.OS === 'ios'
        ? process.env.EXPO_PUBLIC_RC_APPLE_API_KEY!
        : process.env.EXPO_PUBLIC_RC_GOOGLE_API_KEY!;

    Purchases.configure({ apiKey });
  }

  /**
   * Links the RevenueCat customer to the Supabase user.
   * CRITICAL: The app_user_id MUST be the Supabase user.id (UUID).
   * The webhook uses this ID to find and update the Supabase user's app_metadata.
   *
   * Call on every Supabase sign-in (even if the same user — idempotent).
   * Returns isPremium from the linked customer info.
   */
  async logIn(supabaseUserId: string): Promise<boolean> {
    try {
      const { customerInfo } = await Purchases.logIn(supabaseUserId);
      return typeof customerInfo.entitlements.active['premium'] !== 'undefined';
    } catch (error) {
      console.warn('[PremiumService] logIn failed:', error);
      return false; // Do not downgrade on error — caller keeps existing state
    }
  }

  /**
   * Unlinks RevenueCat from the Supabase user identity on sign-out.
   * RevenueCat reverts to anonymous mode.
   */
  async logOut(): Promise<void> {
    try {
      await Purchases.logOut();
    } catch (error) {
      console.warn('[PremiumService] logOut failed:', error);
    }
  }

  /**
   * Point-in-time entitlement check. SDK caches the result — safe to call repeatedly.
   * Returns false on network failure (do not downgrade on error).
   */
  async checkIsPremium(): Promise<boolean> {
    try {
      const customerInfo = await Purchases.getCustomerInfo();
      return typeof customerInfo.entitlements.active['premium'] !== 'undefined';
    } catch (error) {
      console.warn('[PremiumService] getCustomerInfo failed:', error);
      return false;
    }
  }

  /**
   * Registers a real-time listener for entitlement changes.
   * Fires immediately after a purchase completes — before presentPaywall() resolves.
   * Returns the unsubscribe function for cleanup.
   *
   * Usage: call in a useEffect(() => { return PremiumService.addUpdateListener(cb) }, [])
   */
  addUpdateListener(callback: (isPremium: boolean) => void): () => void {
    return Purchases.addCustomerInfoUpdateListener((info) => {
      const isPremium = typeof info.entitlements.active['premium'] !== 'undefined';
      callback(isPremium);
    });
  }
}

export const PremiumService = new PremiumServiceClass();
```
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

    # Verify packages installed
    grep "react-native-purchases" package.json

    # TypeScript check
    npx tsc --noEmit 2>&1 | head -30

    # Verify isPremium added to authStore
    grep "isPremium" src/stores/authStore.ts

    # Verify setIsPremium action present
    grep "setIsPremium" src/stores/authStore.ts

    # Verify PremiumService exports
    grep "export const PremiumService" src/services/PremiumService.ts

    # Verify configure guard (no double-configure)
    grep "this.configured" src/services/PremiumService.ts

    # Verify entitlement identifier is exactly 'premium'
    grep "'premium'" src/services/PremiumService.ts

    # Verify no direct Purchases import outside PremiumService
    grep -rn "from 'react-native-purchases'" src/ app/ --include="*.ts" --include="*.tsx" | grep -v "PremiumService.ts" && echo "WARNING: direct RC import outside PremiumService" || echo "OK: RC isolated to PremiumService"
    ```
    TypeScript must pass with 0 errors. All grep checks return matches.
  </verify>
  <done>
    - `react-native-purchases` and `react-native-purchases-ui` are in package.json
    - `src/stores/authStore.ts` has `isPremium: boolean` (default: false) and `setIsPremium` action — existing fields preserved
    - `src/services/PremiumService.ts` exports `PremiumService` singleton with `configure()`, `logIn()`, `logOut()`, `checkIsPremium()`, `addUpdateListener()`
    - `configure()` is guarded against double-call via `this.configured` flag
    - Entitlement identifier is exactly `'premium'` (matches RevenueCat dashboard)
    - No other file imports directly from `react-native-purchases`
    - TypeScript passes with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usePremiumStatus hook and wire PremiumService into root layout</name>
  <files>
    src/hooks/usePremiumStatus.ts
    app/_layout.tsx
  </files>
  <action>
**Part A — Create src/hooks/usePremiumStatus.ts:**

This hook initializes `isPremium` in `authStore` at startup and registers the real-time listener. It must be called in the root layout (which never unmounts) so the listener persists across all navigation.

```typescript
// src/hooks/usePremiumStatus.ts
//
// Initializes isPremium in authStore and keeps it updated in real time via
// RevenueCat's addCustomerInfoUpdateListener.
//
// On Supabase auth state change:
//   - user signs in → Purchases.logIn(user.id) → isPremium set from returned customerInfo
//   - user signs out → Purchases.logOut() → isPremium set to false
//
// addCustomerInfoUpdateListener fires on purchase completion BEFORE presentPaywall()
// resolves — this is the mechanism for "immediate unlock with no app restart".
//
// IMPORTANT: Call this hook in the root layout ONLY (never unmounts).
// Listener cleanup is returned from useEffect and runs only on full unmount.

import { useEffect } from 'react';
import { useAuth } from '@/src/context/AuthContext';
import { useAuthStore } from '@/src/stores/authStore';
import { PremiumService } from '@/src/services/PremiumService';

export function usePremiumStatus(): void {
  const { user } = useAuth();
  const setIsPremium = useAuthStore((s) => s.setIsPremium);

  // Register real-time listener once at mount.
  // Fires before presentPaywall() resolves after purchase — key for immediate unlock.
  useEffect(() => {
    const cleanup = PremiumService.addUpdateListener((isPremium) => {
      setIsPremium(isPremium);
    });
    return cleanup;
  }, []); // Empty deps — register once, never re-register

  // React to Supabase auth state changes: logIn / logOut with RevenueCat
  useEffect(() => {
    if (user) {
      // Supabase user.id is the RevenueCat app_user_id.
      // logIn links the RC customer to the Supabase user for webhook matching.
      PremiumService.logIn(user.id).then((isPremium) => {
        setIsPremium(isPremium);
      });
    } else {
      // Signed out — log out from RevenueCat and clear premium state
      PremiumService.logOut();
      setIsPremium(false);
    }
  }, [user?.id]); // Re-runs when Supabase user changes
}
```

**Part B — Update app/_layout.tsx:**

Read the current `app/_layout.tsx` (from Phase 5 plan 05-02, it has `AuthProvider`, `useFavoritesSync`, and the combined `isReady` gate).

Make these additions only — do not change any existing logic:

1. Add `PremiumService.configure()` call to the root layout's startup `useEffect`. This MUST run before auth state listeners. Add it at the top of a new `useEffect(() => { ... }, [])` in `RootLayout` (the outer component that wraps `AuthProvider`) so it runs before `AuthProvider` mounts.

2. Add `usePremiumStatus()` call in `RootLayoutInner` — alongside `useFavoritesSync()`.

```typescript
// ADD to imports in app/_layout.tsx:
import { PremiumService } from '@/src/services/PremiumService';
import { usePremiumStatus } from '@/src/hooks/usePremiumStatus';

// ADD to RootLayout (the AuthProvider wrapper component):
// This runs before AuthProvider mounts — guarantees RC is configured before logIn() calls
useEffect(() => {
  PremiumService.configure();
}, []);

// ADD inside RootLayoutInner (alongside useFavoritesSync):
usePremiumStatus();
```

Preserve all existing code in the layout. Do not remove `AuthProvider`, `useFavoritesSync`, the `isReady` gate, or the `Stack` declaration.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

    # TypeScript check
    npx tsc --noEmit 2>&1 | head -30

    # Verify hook exports
    grep "export function usePremiumStatus" src/hooks/usePremiumStatus.ts

    # Verify addUpdateListener registered in empty-dep useEffect
    grep "addUpdateListener\|cleanup" src/hooks/usePremiumStatus.ts

    # Verify auth state effect depends on user?.id (Supabase field)
    grep "user\?\.id" src/hooks/usePremiumStatus.ts

    # Verify PremiumService.configure() called in layout
    grep "PremiumService.configure" app/_layout.tsx

    # Verify usePremiumStatus called in layout
    grep "usePremiumStatus" app/_layout.tsx

    # Verify existing layout features preserved
    grep "AuthProvider\|useFavoritesSync\|isReady\|SplashScreen" app/_layout.tsx
    ```
    TypeScript must pass with 0 errors. All grep checks return matches.
  </verify>
  <done>
    - `usePremiumStatus` exported from `src/hooks/usePremiumStatus.ts`
    - Real-time listener registered in `useEffect([], [])` — empty deps, registered once
    - Listener cleanup returned from `useEffect`
    - Auth state effect depends on `user?.id` (Supabase User field)
    - `PremiumService.configure()` called in `RootLayout` before `AuthProvider` mounts
    - `usePremiumStatus()` called in `RootLayoutInner` alongside `useFavoritesSync`
    - All existing root layout features preserved (AuthProvider, useFavoritesSync, isReady gate, Stack)
    - TypeScript passes with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Supabase sounds table RLS migration and RevenueCat webhook Edge Function</name>
  <files>
    supabase/migrations/20260219000000_sounds_table_rls.sql
    supabase/functions/revenuecat-webhook/index.ts
  </files>
  <action>
**Part A — Create the Supabase migration:**

The sounds catalog is currently in `src/data/sounds.ts` (static TypeScript, established in Phase 3). Premium sound URLs need server-side protection. The approach: create a `sounds` Supabase table that stores premium sound `url` fields. Free sounds serve their URL from the static catalog (no Supabase query needed). Premium sounds fetch their URL from the `sounds` Supabase table which is RLS-protected.

Create `supabase/migrations/20260219000000_sounds_table_rls.sql`:

```sql
-- Phase 6: sounds table for server-side premium URL gating
-- Free sounds serve URLs from static catalog (no Supabase query).
-- Premium sounds fetch URLs from this table — RLS prevents non-premium users from reading them.
--
-- SECURITY: Uses app_metadata (NOT user_metadata).
-- user_metadata is user-writable — never use for authorization.
-- app_metadata is only writable via the service role key (server-side only).
-- The RevenueCat webhook updates app_metadata.is_premium via the Supabase Admin API.

-- Create sounds table (if it doesn't exist from prior phases)
CREATE TABLE IF NOT EXISTS sounds (
  id TEXT PRIMARY KEY,           -- matches SoundConfig.id in src/data/sounds.ts (e.g. 'rain-01')
  url TEXT NOT NULL,             -- audio file URL (Supabase Storage or Firebase Storage signed URL)
  is_premium BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Enable RLS on sounds table
ALTER TABLE sounds ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if re-running this migration
DROP POLICY IF EXISTS "sounds_select_policy" ON sounds;

-- RLS policy: free sounds accessible to all; premium sounds only to premium users.
-- Non-premium users get ZERO rows for premium sounds — the URL never reaches the client.
--
-- CRITICAL: (auth.jwt() -> 'app_metadata' ->> 'is_premium')::boolean IS TRUE
-- Do NOT use user_metadata — it is user-modifiable and unsafe for authorization.
CREATE POLICY "sounds_select_policy"
ON sounds FOR SELECT
USING (
  -- Free sounds: readable by any authenticated or anonymous user
  is_premium = false
  OR
  -- Premium sounds: only if app_metadata.is_premium = true (server-set only via Admin API)
  (
    (auth.jwt() -> 'app_metadata' ->> 'is_premium')::boolean IS TRUE
  )
);

-- Allow service role to insert/update sound records (for seeding premium URLs)
-- Regular users cannot write to this table (no INSERT/UPDATE/DELETE policy)
```

**Part B — Create the RevenueCat webhook Edge Function:**

Create `supabase/functions/revenuecat-webhook/index.ts`. This Edge Function receives RevenueCat lifecycle events and updates the Supabase user's `app_metadata.is_premium`.

The Supabase `app_user_id` in the webhook payload equals the Supabase `user.id` — because `PremiumService.logIn(user.id)` sets this mapping when the user signs in.

```typescript
// supabase/functions/revenuecat-webhook/index.ts
//
// Receives RevenueCat webhook events and updates Supabase user app_metadata.
//
// Security:
//   - Verifies Authorization header against REVENUECAT_WEBHOOK_SECRET env var
//   - Uses service role key (SUPABASE_SERVICE_ROLE_KEY) to bypass RLS for admin update
//   - app_metadata is not user-modifiable — safe for authorization decisions
//
// RevenueCat webhook events handled:
//   INITIAL_PURCHASE, RENEWAL, UNCANCELLATION → is_premium: true
//   EXPIRATION → is_premium: false
//   CANCELLATION → NO CHANGE (subscription active until period end; EXPIRATION fires later)
//   BILLING_ISSUE → NO CHANGE (RevenueCat has grace period handling; EXPIRATION fires on end)
//
// RevenueCat retry behavior: retries on any non-2xx response — return 200 always on success.
//
// app_user_id in the payload equals supabaseUser.id because PremiumService.logIn(user.id)
// was called when the user authenticated (see src/services/PremiumService.ts).

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const EVENTS_GRANTING_PREMIUM = new Set([
  'INITIAL_PURCHASE',
  'RENEWAL',
  'UNCANCELLATION',
]);

const EVENTS_REVOKING_PREMIUM = new Set([
  'EXPIRATION',
]);

Deno.serve(async (req: Request) => {
  // Only allow POST
  if (req.method !== 'POST') {
    return new Response('Method Not Allowed', { status: 405 });
  }

  // Verify RevenueCat authorization header
  const authHeader = req.headers.get('Authorization');
  const expectedSecret = Deno.env.get('REVENUECAT_WEBHOOK_SECRET');

  if (!expectedSecret || authHeader !== `Bearer ${expectedSecret}`) {
    console.error('[revenuecat-webhook] Unauthorized request');
    return new Response('Unauthorized', { status: 401 });
  }

  let event: { type: string; app_user_id: string };
  try {
    event = await req.json();
  } catch {
    return new Response('Bad Request: invalid JSON', { status: 400 });
  }

  const { type: eventType, app_user_id: supabaseUserId } = event;

  if (!supabaseUserId) {
    return new Response('Bad Request: missing app_user_id', { status: 400 });
  }

  // Determine new premium status from event type
  let isPremium: boolean | null = null;
  if (EVENTS_GRANTING_PREMIUM.has(eventType)) {
    isPremium = true;
  } else if (EVENTS_REVOKING_PREMIUM.has(eventType)) {
    isPremium = false;
  } else {
    // CANCELLATION, BILLING_ISSUE, etc. — do not change is_premium
    // Subscription remains active until EXPIRATION fires
    console.log(`[revenuecat-webhook] Ignoring event type: ${eventType}`);
    return new Response(JSON.stringify({ ok: true, action: 'ignored' }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    });
  }

  // Use service role key — bypasses RLS, required for admin.updateUserById
  const supabaseAdmin = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!,
  );

  const { error } = await supabaseAdmin.auth.admin.updateUserById(supabaseUserId, {
    app_metadata: { is_premium: isPremium },
  });

  if (error) {
    console.error('[revenuecat-webhook] Failed to update user:', error);
    // Return 500 so RevenueCat retries the event
    return new Response('Internal Server Error', { status: 500 });
  }

  console.log(`[revenuecat-webhook] Updated ${supabaseUserId}: is_premium=${isPremium} (event: ${eventType})`);

  return new Response(JSON.stringify({ ok: true }), {
    status: 200,
    headers: { 'Content-Type': 'application/json' },
  });
});
```
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

    # Verify migration file exists
    ls supabase/migrations/20260219000000_sounds_table_rls.sql

    # Verify RLS policy uses app_metadata (NOT user_metadata)
    grep "app_metadata" supabase/migrations/20260219000000_sounds_table_rls.sql
    grep "user_metadata" supabase/migrations/20260219000000_sounds_table_rls.sql && echo "WARNING: user_metadata found — SECURITY RISK" || echo "OK: no user_metadata"

    # Verify RLS is enabled
    grep "ENABLE ROW LEVEL SECURITY" supabase/migrations/20260219000000_sounds_table_rls.sql

    # Verify Edge Function file exists
    ls supabase/functions/revenuecat-webhook/index.ts

    # Verify authorization check in Edge Function
    grep "REVENUECAT_WEBHOOK_SECRET\|Unauthorized" supabase/functions/revenuecat-webhook/index.ts

    # Verify service role key used (not anon key)
    grep "SUPABASE_SERVICE_ROLE_KEY" supabase/functions/revenuecat-webhook/index.ts

    # Verify updateUserById call
    grep "updateUserById" supabase/functions/revenuecat-webhook/index.ts

    # Verify app_metadata (not user_metadata) updated
    grep "app_metadata" supabase/functions/revenuecat-webhook/index.ts
    grep "user_metadata" supabase/functions/revenuecat-webhook/index.ts && echo "WARNING: user_metadata found in webhook" || echo "OK: no user_metadata in webhook"

    # Verify EXPIRATION revokes premium (not CANCELLATION)
    grep "EXPIRATION" supabase/functions/revenuecat-webhook/index.ts
    grep "CANCELLATION" supabase/functions/revenuecat-webhook/index.ts
    ```
    All checks pass. No `user_metadata` in migration or Edge Function.
  </verify>
  <done>
    - `supabase/migrations/20260219000000_sounds_table_rls.sql` creates `sounds` table and RLS policy using `app_metadata` (not `user_metadata`)
    - RLS policy: free sounds readable by all; premium sounds only when `app_metadata.is_premium IS TRUE`
    - `supabase/functions/revenuecat-webhook/index.ts` verifies `Authorization: Bearer <REVENUECAT_WEBHOOK_SECRET>` before processing any event
    - Webhook uses Supabase service role key (not anon key) for `admin.updateUserById`
    - Updates `app_metadata.is_premium: true` for INITIAL_PURCHASE, RENEWAL, UNCANCELLATION
    - Updates `app_metadata.is_premium: false` for EXPIRATION only (CANCELLATION is a no-op — subscription still active)
    - Returns 200 for success, 500 for errors (triggers RevenueCat retry), 401 for unauthorized
    - No `user_metadata` used anywhere
  </done>
</task>

</tasks>

<verification>
After all three tasks complete:

```bash
cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds

# Full TypeScript check
npx tsc --noEmit
# Expected: 0 errors

# isPremium in authStore
grep "isPremium.*boolean\|setIsPremium" src/stores/authStore.ts

# PremiumService: all methods present
grep "configure\|logIn\|logOut\|checkIsPremium\|addUpdateListener" src/services/PremiumService.ts | head -10

# usePremiumStatus: listener + auth state reaction
grep "addUpdateListener\|user\?\.id\|setIsPremium" src/hooks/usePremiumStatus.ts

# Root layout: configure before auth, hook in RootLayoutInner
grep "PremiumService.configure\|usePremiumStatus" app/_layout.tsx

# Migration: RLS on sounds table with app_metadata
grep "ENABLE ROW LEVEL SECURITY\|app_metadata\|is_premium" supabase/migrations/20260219000000_sounds_table_rls.sql

# Webhook: auth check + admin update
grep "REVENUECAT_WEBHOOK_SECRET\|updateUserById\|app_metadata" supabase/functions/revenuecat-webhook/index.ts

# Security: confirm user_metadata NOT used anywhere in Phase 6 files
grep -rn "user_metadata" src/services/PremiumService.ts src/hooks/usePremiumStatus.ts supabase/migrations/20260219000000_sounds_table_rls.sql supabase/functions/revenuecat-webhook/index.ts && echo "FAIL: user_metadata found" || echo "PASS: app_metadata only"
```
</verification>

<success_criteria>
- `react-native-purchases` and `react-native-purchases-ui` installed (in package.json)
- `authStore.isPremium` (false default) and `setIsPremium` action present; existing store fields unchanged
- `PremiumService` singleton isolates all RevenueCat calls; guarded `configure()`, `logIn(userId)`, `logOut()`, `checkIsPremium()`, `addUpdateListener(cb)`
- `usePremiumStatus` hook registered in root layout — real-time listener + auth-state-driven logIn/logOut
- `PremiumService.configure()` called in `RootLayout` before `AuthProvider` mounts
- Supabase migration creates `sounds` table with `is_premium`, `url` columns and RLS policy using `app_metadata` (never `user_metadata`)
- RevenueCat webhook Edge Function verifies Authorization header, updates `app_metadata.is_premium` via Admin API, handles INITIAL_PURCHASE/RENEWAL/UNCANCELLATION/EXPIRATION correctly
- `npx tsc --noEmit` exits 0 across all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/06-freemium-and-monetization/06-01-SUMMARY.md` documenting:
- Which version of react-native-purchases was installed (verify from package.json)
- How isPremium was added to authStore (any conflicts with existing Phase 5 additions?)
- PremiumService: configure() guard pattern, logIn() → isPremium result flow
- usePremiumStatus: listener cleanup pattern, why empty-dep useEffect for listener
- Root layout wiring: where configure() call sits relative to AuthProvider
- Migration: whether sounds table already existed from prior phases (Phase 3 may have created it)
- Webhook: any Supabase Edge Function deployment issues
- Any TypeScript issues and resolution
</output>
