---
phase: 03-core-ui
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - app/_layout.tsx
  - app/(onboarding)/index.tsx
  - app/(onboarding)/quiet-mode.tsx
  - app/(tabs)/settings.tsx
autonomous: false
requirements:
  - SET-01
  - ONBRD-01

must_haves:
  truths:
    - "First-time users see the onboarding Welcome screen (not the library) on first launch"
    - "Returning users bypass onboarding and land directly on the library"
    - "Onboarding Welcome screen shows: logo/icon, 'Find your calm in a minute', 'ULTRA-SHORT SOUNDS', 'Begin' button"
    - "Tapping 'Begin' navigates to the Quiet Mode onboarding screen (Screen 2)"
    - "Quiet Mode screen shows a DND toggle (pre-enabled, non-functional shell) with 'Continue' and 'Not now' buttons"
    - "Tapping 'Continue' OR 'Not now' sets the AsyncStorage onboarding flag and navigates to the library (tabs)"
    - "The Settings screen renders the full mock layout: dark mode toggle (functional), Session Duration (shell), Loop Mode (shell), Auto-play Next (shell), Silence Notifications (shell), Support & FAQ (no-op), Share with Friends (no-op)"
    - "Toggling dark mode in Settings changes the app background between #0f1115 (dark) and #f8f8f8 (light)"
    - "Dark mode preference persists across app restarts (Zustand persist + AsyncStorage)"
  artifacts:
    - path: "app/_layout.tsx"
      provides: "Root layout with AsyncStorage onboarding check + SplashScreen hold + router.replace to (onboarding) or (tabs)"
      contains: "has_seen_onboarding"
    - path: "app/(onboarding)/index.tsx"
      provides: "Welcome screen: logo, headline, ULTRA-SHORT SOUNDS label, Begin button"
      min_lines: 60
    - path: "app/(onboarding)/quiet-mode.tsx"
      provides: "Quiet Mode screen: DND toggle (shell, pre-enabled), Continue + Not now buttons, sets AsyncStorage flag and navigates to (tabs)"
      min_lines: 60
    - path: "app/(tabs)/settings.tsx"
      provides: "Settings screen with dark mode toggle functional (useUIStore.toggleDarkMode), all other rows as visual shells"
      min_lines: 100
  key_links:
    - from: "app/_layout.tsx"
      to: "AsyncStorage.getItem('has_seen_onboarding')"
      via: "useEffect in root layout before routing"
      pattern: "has_seen_onboarding"
    - from: "app/_layout.tsx"
      to: "SplashScreen.hideAsync"
      via: "called after onboarding check resolves"
      pattern: "hideAsync"
    - from: "app/(onboarding)/quiet-mode.tsx"
      to: "AsyncStorage.setItem('has_seen_onboarding', 'true')"
      via: "handleContinue and handleNotNow callbacks"
      pattern: "setItem.*has_seen_onboarding"
    - from: "app/(tabs)/settings.tsx"
      to: "useUIStore toggleDarkMode"
      via: "Switch onValueChange"
      pattern: "toggleDarkMode"
    - from: "app/(tabs)/settings.tsx"
      to: "useUIStore isDarkMode"
      via: "Switch value prop and background color"
      pattern: "isDarkMode"
---

<objective>
Complete the app's first-launch experience and settings layer: wire onboarding detection into the root layout (AsyncStorage flag + SplashScreen hold), build the 2-screen onboarding flow (Welcome + Quiet Mode shell), and build the Settings screen with a functional dark mode toggle.

Purpose: This plan closes the loop on the three requirements that don't belong to the library or player: first-launch routing (ONBRD-01), dark mode toggle (SET-01), and the settings shell. After this plan, Phase 3 is complete.
Output: A fully navigable app from first launch through the library, player, onboarding, and settings â€” all in under 3 taps.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-ui/03-RESEARCH.md
@.planning/phases/03-core-ui/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire onboarding detection into root layout</name>
  <files>
    app/_layout.tsx
  </files>
  <action>
Update `app/_layout.tsx` to add the onboarding routing logic. This plan's 03-01 created the basic Stack declaration; now add the AsyncStorage check and first-launch routing.

The approach (from research Pattern 5):
- AsyncStorage key: `'has_seen_onboarding'`
- On mount: check AsyncStorage asynchronously, keep SplashScreen visible during the check
- If key is null (never set): navigate to `/(onboarding)`, then mark it done when user completes onboarding in quiet-mode.tsx
- If key is set: navigate to `/(tabs)` immediately
- Call SplashScreen.hideAsync() after routing decision is made
- Track readiness with useState to avoid rendering the Stack before routing is determined

IMPORTANT: `SplashScreen.preventAutoHideAsync()` must be called at module level (top of file, outside the component), not inside useEffect.

Research pitfall 8: `router.replace()` must be called inside a `useEffect`, not during render. Check that the layout has mounted before navigating.

```typescript
import { Stack, router } from 'expo-router';
import { useEffect, useState } from 'react';
import * as SplashScreen from 'expo-splash-screen';
import AsyncStorage from '@react-native-async-storage/async-storage';

// MUST be called at module level before component renders
SplashScreen.preventAutoHideAsync();

const ONBOARDING_KEY = 'has_seen_onboarding';

export default function RootLayout() {
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    async function prepare() {
      try {
        const seen = await AsyncStorage.getItem(ONBOARDING_KEY);
        if (seen) {
          router.replace('/(tabs)');
        } else {
          router.replace('/(onboarding)');
        }
      } catch (e) {
        // On error, default to tabs (do not block user in onboarding loop)
        router.replace('/(tabs)');
      } finally {
        setIsReady(true);
        await SplashScreen.hideAsync();
      }
    }
    prepare();
  }, []);

  if (!isReady) {
    return null; // Hold render until routing is resolved; SplashScreen still showing
  }

  return (
    <Stack>
      <Stack.Screen name="(onboarding)" options={{ headerShown: false }} />
      <Stack.Screen name="(tabs)" options={{ headerShown: false }} />
      <Stack.Screen
        name="player"
        options={{
          headerShown: false,
          presentation: 'fullScreenModal',
          animation: 'fade',
        }}
      />
    </Stack>
  );
}
```

If a _layout.tsx was already created in plan 03-01, read the current file content and merge â€” do not overwrite any additions made in that plan. The Stack.Screen declarations from 03-01 must be preserved; only add the onboarding routing logic (useEffect, useState, AsyncStorage check).
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    npx tsc --noEmit 2>&1 | grep "_layout" | head -10
    grep -n "has_seen_onboarding" app/_layout.tsx
    grep -n "SplashScreen.preventAutoHideAsync" app/_layout.tsx
    grep -n "SplashScreen.hideAsync" app/_layout.tsx
    ```
    All three greps return results. TypeScript passes for _layout.tsx.

    Behavioral test: Clear AsyncStorage (or use a fresh simulator) â†’ app should show onboarding. Install on simulator with existing state â†’ app should show library directly.
  </verify>
  <done>
    - SplashScreen.preventAutoHideAsync() called at module level
    - useEffect checks AsyncStorage for 'has_seen_onboarding' key
    - router.replace('/(onboarding)') if key is null; router.replace('/(tabs)') if set
    - SplashScreen.hideAsync() called after routing decision
    - Error case falls through to tabs (no infinite onboarding loop)
    - Stack still declares all three sibling screens: (onboarding), (tabs), player
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the 2-screen onboarding flow</name>
  <files>
    app/(onboarding)/index.tsx
    app/(onboarding)/quiet-mode.tsx
  </files>
  <action>
1. Create `app/(onboarding)/index.tsx` â€” Welcome screen (Screen 1 of onboarding):

   Design reference: `mock/onboarding_welcome/` â€” minimal, calm. Single column centered layout.
   - Full screen background: `#0f1115` (charcoal)
   - App logo/icon: a simple circle or sound wave icon centered in the upper half. Use a text emoji "ðŸŽµ" or a MaterialIcons `"music-note"` (size 64, color `#8b5cf6`) as the logo placeholder â€” no image asset needed.
   - Headline: "Find your calm in a minute" â€” white, fontSize 28, fontWeight '300', textAlign 'center', fontStyle 'italic' or normal, centered
   - Sub-label: "ULTRA-SHORT SOUNDS" â€” `#8b5cf6`, fontSize 12, fontWeight '600', letterSpacing 3, textAlign 'center', marginTop 8
   - Description (optional, small): "1 to 3 minute audio loops, no setup required." â€” rgba(255,255,255,0.5), fontSize 14, centered, marginTop 16
   - "Begin" button at the bottom: full-width (minus 48px margins), height 56, backgroundColor `#8b5cf6`, borderRadius 16, white text "Begin", fontSize 17, fontWeight '600'. onPress: navigate to `/(onboarding)/quiet-mode`
   - Bottom padding to account for safe area (use SafeAreaView or paddingBottom: 48)

   ```typescript
   import { View, Text, TouchableOpacity, StyleSheet, SafeAreaView } from 'react-native';
   import { router } from 'expo-router';
   import { MaterialIcons } from '@expo/vector-icons';

   export default function OnboardingWelcome() {
     return (
       <SafeAreaView style={styles.container}>
         <View style={styles.content}>
           <View style={styles.logoContainer}>
             <MaterialIcons name="music-note" size={64} color="#8b5cf6" />
           </View>
           <Text style={styles.headline}>Find your calm{'\n'}in a minute</Text>
           <Text style={styles.subLabel}>ULTRA-SHORT SOUNDS</Text>
           <Text style={styles.description}>
             1 to 3 minute audio loops.{'\n'}No setup required.
           </Text>
         </View>
         <View style={styles.footer}>
           <TouchableOpacity
             style={styles.beginButton}
             onPress={() => router.push('/(onboarding)/quiet-mode')}
             activeOpacity={0.85}
           >
             <Text style={styles.beginText}>Begin</Text>
           </TouchableOpacity>
         </View>
       </SafeAreaView>
     );
   }

   const styles = StyleSheet.create({
     container: { flex: 1, backgroundColor: '#0f1115' },
     content: { flex: 1, alignItems: 'center', justifyContent: 'center', paddingHorizontal: 24 },
     logoContainer: {
       width: 96,
       height: 96,
       borderRadius: 48,
       backgroundColor: 'rgba(139,92,246,0.12)',
       alignItems: 'center',
       justifyContent: 'center',
       marginBottom: 40,
     },
     headline: {
       color: '#ffffff',
       fontSize: 30,
       fontWeight: '300',
       textAlign: 'center',
       lineHeight: 40,
     },
     subLabel: {
       color: '#8b5cf6',
       fontSize: 11,
       fontWeight: '700',
       letterSpacing: 3,
       textAlign: 'center',
       marginTop: 16,
     },
     description: {
       color: 'rgba(255,255,255,0.45)',
       fontSize: 15,
       textAlign: 'center',
       marginTop: 20,
       lineHeight: 22,
     },
     footer: {
       paddingHorizontal: 24,
       paddingBottom: 16,
     },
     beginButton: {
       backgroundColor: '#8b5cf6',
       borderRadius: 16,
       height: 56,
       alignItems: 'center',
       justifyContent: 'center',
     },
     beginText: {
       color: '#ffffff',
       fontSize: 17,
       fontWeight: '600',
     },
   });
   ```

2. Create `app/(onboarding)/quiet-mode.tsx` â€” Quiet Mode screen (Screen 2 of onboarding):

   Design reference: `mock/onboarding_permissions/` â€” one toggle, two CTA buttons.
   - Full screen background: `#0f1115`
   - Title: "Enable Quiet Mode" â€” white, fontSize 24, fontWeight '300', centered
   - Description: "Block notifications during your session so nothing interrupts your calm." â€” rgba(255,255,255,0.5), centered, fontSize 15
   - DND toggle row: a horizontal row with label "Do Not Disturb" (white, fontSize 16) on left and a `Switch` on right. Switch value: local state `dndEnabled` initialized to `true` (pre-enabled per context decision). Toggle is VISUAL ONLY â€” no functional DND implementation in Phase 3.
   - "Continue" button: same style as "Begin" â€” full width, backgroundColor `#8b5cf6`, height 56, borderRadius 16
   - "Not now" button below: transparent background, text only, color rgba(255,255,255,0.5), fontSize 15
   - Both "Continue" and "Not now" call the SAME `handleComplete` function which:
     1. Calls `AsyncStorage.setItem('has_seen_onboarding', 'true')`
     2. Calls `router.replace('/(tabs)')` to navigate to the library

   ```typescript
   import { View, Text, TouchableOpacity, Switch, StyleSheet, SafeAreaView } from 'react-native';
   import { router } from 'expo-router';
   import { useState } from 'react';
   import AsyncStorage from '@react-native-async-storage/async-storage';

   const ONBOARDING_KEY = 'has_seen_onboarding';

   export default function QuietModeScreen() {
     const [dndEnabled, setDndEnabled] = useState(true); // pre-enabled, visual only

     async function handleComplete() {
       await AsyncStorage.setItem(ONBOARDING_KEY, 'true');
       router.replace('/(tabs)');
     }

     return (
       <SafeAreaView style={styles.container}>
         <View style={styles.content}>
           <Text style={styles.title}>Enable Quiet Mode</Text>
           <Text style={styles.description}>
             Block notifications during your session so nothing interrupts your calm.
           </Text>

           {/* DND toggle row â€” visual shell only */}
           <View style={styles.toggleRow}>
             <Text style={styles.toggleLabel}>Do Not Disturb</Text>
             <Switch
               value={dndEnabled}
               onValueChange={setDndEnabled}
               trackColor={{ false: 'rgba(255,255,255,0.15)', true: '#8b5cf6' }}
               thumbColor="#ffffff"
             />
           </View>

           <Text style={styles.notice}>
             This can be changed later in Settings.
           </Text>
         </View>

         <View style={styles.footer}>
           <TouchableOpacity style={styles.continueButton} onPress={handleComplete} activeOpacity={0.85}>
             <Text style={styles.continueText}>Continue</Text>
           </TouchableOpacity>
           <TouchableOpacity style={styles.skipButton} onPress={handleComplete}>
             <Text style={styles.skipText}>Not now</Text>
           </TouchableOpacity>
         </View>
       </SafeAreaView>
     );
   }

   const styles = StyleSheet.create({
     container: { flex: 1, backgroundColor: '#0f1115' },
     content: { flex: 1, paddingHorizontal: 24, paddingTop: 60 },
     title: {
       color: '#ffffff',
       fontSize: 28,
       fontWeight: '300',
       textAlign: 'center',
       marginBottom: 16,
     },
     description: {
       color: 'rgba(255,255,255,0.5)',
       fontSize: 15,
       textAlign: 'center',
       lineHeight: 22,
       marginBottom: 40,
     },
     toggleRow: {
       flexDirection: 'row',
       justifyContent: 'space-between',
       alignItems: 'center',
       backgroundColor: 'rgba(255,255,255,0.06)',
       borderRadius: 14,
       paddingHorizontal: 20,
       paddingVertical: 18,
     },
     toggleLabel: {
       color: '#ffffff',
       fontSize: 16,
       fontWeight: '400',
     },
     notice: {
       color: 'rgba(255,255,255,0.3)',
       fontSize: 12,
       textAlign: 'center',
       marginTop: 16,
     },
     footer: {
       paddingHorizontal: 24,
       paddingBottom: 16,
       gap: 12,
     },
     continueButton: {
       backgroundColor: '#8b5cf6',
       borderRadius: 16,
       height: 56,
       alignItems: 'center',
       justifyContent: 'center',
     },
     continueText: {
       color: '#ffffff',
       fontSize: 17,
       fontWeight: '600',
     },
     skipButton: {
       height: 44,
       alignItems: 'center',
       justifyContent: 'center',
     },
     skipText: {
       color: 'rgba(255,255,255,0.45)',
       fontSize: 15,
     },
   });
   ```
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    npx tsc --noEmit 2>&1 | grep -E "onboarding|quiet" | head -10
    grep -n "has_seen_onboarding" app/\(onboarding\)/quiet-mode.tsx
    grep -n "router.replace" app/\(onboarding\)/quiet-mode.tsx
    ```
    Both greps return results. TypeScript passes for both files.

    Behavioral test: First launch (AsyncStorage cleared) â†’ Welcome screen shows â†’ tap Begin â†’ Quiet Mode screen â†’ tap Continue â†’ lands on library tab. Relaunch â†’ skips onboarding, lands directly on library.
  </verify>
  <done>
    - Welcome screen renders with logo icon, headline, "ULTRA-SHORT SOUNDS" label, "Begin" button
    - Quiet Mode screen renders with DND toggle (pre-enabled, visual only), Continue and Not now buttons
    - Both Continue and Not now set AsyncStorage key and navigate to (tabs)
    - After completing onboarding and relaunching, root layout routes directly to (tabs)
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Settings screen with functional dark mode toggle</name>
  <files>
    app/(tabs)/settings.tsx
  </files>
  <action>
Create `app/(tabs)/settings.tsx` â€” the full Settings screen layout as shown in `mock/app_settings_and_timer/`. Dark mode toggle is FUNCTIONAL (SET-01). All other settings are visual shells.

Design: grouped sections with section headers, row items with label + control (switch or segmented control or chevron). Background: `#0f1115`, section backgrounds: `rgba(255,255,255,0.05)`, section headers: rgba(255,255,255,0.4) small caps.

Sections and rows:
1. **Playback** section:
   - Session Duration â€” 3-option segmented control: 1m / 2m / 3m. Local state `sessionDuration` (visual only, non-functional in Phase 3). Note in inline comment: "Functional in Phase 4"
   - Loop Mode â€” Switch, local state `loopMode` (default false, visual only). Note: "Wired to audioStore in Phase 2; settings toggle functional in Phase 4"
   - Auto-play Next â€” Switch, local state `autoplayNext` (default false, visual only). Note: "Not yet scoped"

2. **Appearance** section:
   - Dark Mode â€” Switch, value from `useUIStore().isDarkMode`, onValueChange calls `useUIStore().toggleDarkMode`. THIS IS THE ONLY FUNCTIONAL CONTROL. Also apply `_hasHydrated` guard: if !_hasHydrated return null.

3. **Notifications** section:
   - Silence Notifications â€” Switch, local state (default false, visual only). Note: "Phase 7"

4. **Support** section:
   - Support & FAQ â€” row with chevron, onPress: no-op (console.log or nothing)
   - Share with Friends â€” row with chevron, onPress: no-op

Dark mode effect: the Settings screen itself should reflect the dark mode state. In Phase 3, implement it simply â€” the screen background changes based on `isDarkMode`:
- isDarkMode true: `backgroundColor: '#0f1115'`, text: `#ffffff`
- isDarkMode false: `backgroundColor: '#f5f5f5'`, text: `#1a1a1a`

This is a simplified per-screen implementation. A full theme system can be built in Phase 4+.

```typescript
import {
  View,
  Text,
  Switch,
  TouchableOpacity,
  ScrollView,
  StyleSheet,
  SafeAreaView,
} from 'react-native';
import { useState } from 'react';
import { MaterialIcons } from '@expo/vector-icons';
import { useUIStore } from '@/src/stores/uiStore';

// Segmented control for session duration (3 options)
function SegmentedControl({
  options,
  selected,
  onSelect,
  isDark,
}: {
  options: string[];
  selected: string;
  onSelect: (v: string) => void;
  isDark: boolean;
}) {
  return (
    <View style={[seg.container, { backgroundColor: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)' }]}>
      {options.map((opt) => (
        <TouchableOpacity
          key={opt}
          onPress={() => onSelect(opt)}
          style={[
            seg.option,
            selected === opt && { backgroundColor: '#8b5cf6' },
          ]}
        >
          <Text style={[seg.text, { color: selected === opt ? '#ffffff' : isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.5)' }]}>
            {opt}
          </Text>
        </TouchableOpacity>
      ))}
    </View>
  );
}

const seg = StyleSheet.create({
  container: { flexDirection: 'row', borderRadius: 10, padding: 2 },
  option: { flex: 1, paddingVertical: 8, alignItems: 'center', borderRadius: 8 },
  text: { fontSize: 13, fontWeight: '500' },
});

export default function SettingsScreen() {
  const { isDarkMode, _hasHydrated, toggleDarkMode } = useUIStore();

  // Visual shell states (non-functional in Phase 3)
  const [sessionDuration, setSessionDuration] = useState('2m');
  const [loopMode, setLoopMode] = useState(false);
  const [autoplayNext, setAutoplayNext] = useState(false);
  const [silenceNotifications, setSilenceNotifications] = useState(false);

  // Wait for hydration to avoid dark mode flash
  if (!_hasHydrated) return null;

  const bg = isDarkMode ? '#0f1115' : '#f5f5f5';
  const sectionBg = isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.04)';
  const labelColor = isDarkMode ? '#ffffff' : '#1a1a1a';
  const subColor = isDarkMode ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.4)';
  const headerColor = isDarkMode ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.35)';

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: bg }]}>
      <Text style={[styles.screenTitle, { color: labelColor }]}>Settings</Text>
      <ScrollView contentContainerStyle={styles.scroll} showsVerticalScrollIndicator={false}>

        {/* Playback */}
        <Text style={[styles.sectionHeader, { color: headerColor }]}>PLAYBACK</Text>
        <View style={[styles.section, { backgroundColor: sectionBg }]}>
          <View style={styles.row}>
            <View>
              <Text style={[styles.label, { color: labelColor }]}>Session Duration</Text>
              <Text style={[styles.sub, { color: subColor }]}>Auto-stop after</Text>
            </View>
          </View>
          <SegmentedControl
            options={['1m', '2m', '3m']}
            selected={sessionDuration}
            onSelect={setSessionDuration}
            isDark={isDarkMode}
          />
          <View style={styles.divider} />
          <View style={styles.row}>
            <View style={{ flex: 1 }}>
              <Text style={[styles.label, { color: labelColor }]}>Loop Mode</Text>
              <Text style={[styles.sub, { color: subColor }]}>Repeat until stopped</Text>
            </View>
            <Switch
              value={loopMode}
              onValueChange={setLoopMode}
              trackColor={{ false: 'rgba(255,255,255,0.15)', true: '#8b5cf6' }}
              thumbColor="#ffffff"
            />
          </View>
          <View style={styles.divider} />
          <View style={styles.row}>
            <View style={{ flex: 1 }}>
              <Text style={[styles.label, { color: labelColor }]}>Auto-play Next</Text>
              <Text style={[styles.sub, { color: subColor }]}>Play next sound when session ends</Text>
            </View>
            <Switch
              value={autoplayNext}
              onValueChange={setAutoplayNext}
              trackColor={{ false: 'rgba(255,255,255,0.15)', true: '#8b5cf6' }}
              thumbColor="#ffffff"
            />
          </View>
        </View>

        {/* Appearance */}
        <Text style={[styles.sectionHeader, { color: headerColor }]}>APPEARANCE</Text>
        <View style={[styles.section, { backgroundColor: sectionBg }]}>
          <View style={styles.row}>
            <View style={{ flex: 1 }}>
              <Text style={[styles.label, { color: labelColor }]}>Dark Mode</Text>
              <Text style={[styles.sub, { color: subColor }]}>On by default</Text>
            </View>
            {/* FUNCTIONAL: this toggle actually changes the app theme */}
            <Switch
              value={isDarkMode}
              onValueChange={toggleDarkMode}
              trackColor={{ false: 'rgba(0,0,0,0.15)', true: '#8b5cf6' }}
              thumbColor="#ffffff"
            />
          </View>
        </View>

        {/* Notifications */}
        <Text style={[styles.sectionHeader, { color: headerColor }]}>NOTIFICATIONS</Text>
        <View style={[styles.section, { backgroundColor: sectionBg }]}>
          <View style={styles.row}>
            <View style={{ flex: 1 }}>
              <Text style={[styles.label, { color: labelColor }]}>Silence Notifications</Text>
              <Text style={[styles.sub, { color: subColor }]}>During active sessions â€” Phase 7</Text>
            </View>
            <Switch
              value={silenceNotifications}
              onValueChange={setSilenceNotifications}
              trackColor={{ false: 'rgba(255,255,255,0.15)', true: '#8b5cf6' }}
              thumbColor="#ffffff"
            />
          </View>
        </View>

        {/* Support */}
        <Text style={[styles.sectionHeader, { color: headerColor }]}>SUPPORT</Text>
        <View style={[styles.section, { backgroundColor: sectionBg }]}>
          <TouchableOpacity style={styles.row} onPress={() => {}}>
            <Text style={[styles.label, { color: labelColor }]}>Support & FAQ</Text>
            <MaterialIcons name="chevron-right" size={20} color={subColor} />
          </TouchableOpacity>
          <View style={styles.divider} />
          <TouchableOpacity style={styles.row} onPress={() => {}}>
            <Text style={[styles.label, { color: labelColor }]}>Share with Friends</Text>
            <MaterialIcons name="chevron-right" size={20} color={subColor} />
          </TouchableOpacity>
        </View>

        <View style={{ height: 120 }} />
      </ScrollView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  screenTitle: {
    fontSize: 28,
    fontWeight: '700',
    paddingHorizontal: 24,
    paddingTop: 16,
    paddingBottom: 8,
  },
  scroll: { paddingHorizontal: 16 },
  sectionHeader: {
    fontSize: 11,
    fontWeight: '600',
    letterSpacing: 1.5,
    marginTop: 24,
    marginBottom: 8,
    marginLeft: 8,
  },
  section: {
    borderRadius: 14,
    overflow: 'hidden',
    paddingHorizontal: 16,
  },
  row: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 14,
  },
  label: { fontSize: 16, fontWeight: '400' },
  sub: { fontSize: 12, marginTop: 2 },
  divider: { height: StyleSheet.hairlineWidth, backgroundColor: 'rgba(255,255,255,0.08)' },
});
```
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    npx tsc --noEmit 2>&1 | grep "settings" | head -10
    grep -n "toggleDarkMode\|isDarkMode" app/\(tabs\)/settings.tsx
    grep -n "_hasHydrated" app/\(tabs\)/settings.tsx
    ```
    TypeScript passes. Both greps return results.

    Behavioral test:
    1. Open Settings â†’ dark mode switch is ON (default)
    2. Toggle dark mode switch â†’ screen background changes from #0f1115 to #f5f5f5 immediately
    3. Navigate to library (tab) â†’ library background also changed (if library reads from uiStore)
    4. Close and relaunch app â†’ dark mode preference is preserved (persisted via Zustand + AsyncStorage)
  </verify>
  <done>
    - Settings screen renders all 4 sections: Playback, Appearance, Notifications, Support
    - Dark mode Switch reads from isDarkMode and calls toggleDarkMode on change â€” FUNCTIONAL
    - Screen background and text colors change immediately when dark mode is toggled
    - _hasHydrated guard prevents rendering before Zustand rehydration (no dark mode flash)
    - Session Duration, Loop Mode, Auto-play Next, Silence Notifications are visual shells (local state only)
    - Support & FAQ and Share with Friends are no-op touch rows with chevron icons
    - No TypeScript errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Phase 3 Core UI end-to-end on device</name>
  <action>No automated action â€” this checkpoint requires human verification of the UI on a device or simulator.</action>
  <what-built>
    Complete Phase 3 Core UI:
    - 03-01: Navigation shell, sound library (17 sounds, 4 categories), SoundCard, CategorySection, uiStore, frosted tab bar
    - 03-02: Player screen with ambient video, fullscreen immersive mode, CircularProgressArc, BottomControlPill
    - 03-03: Onboarding 2-screen flow, Settings screen with functional dark mode, onboarding detection in root layout
  </what-built>
  <how-to-verify>
    Run the app on a simulator or device (EAS Development Build required for expo-video):
    ```bash
    npx expo start
    ```

    Test each success criterion from the phase goal:

    1. **Onboarding (first launch):**
       - Clear AsyncStorage or use a fresh simulator
       - App shows Welcome screen: "Find your calm in a minute", "ULTRA-SHORT SOUNDS", "Begin" button
       - Tap Begin â†’ Quiet Mode screen with pre-enabled DND toggle
       - Tap Continue â†’ library screen loads
       - Relaunch â†’ goes directly to library (no onboarding repeat)

    2. **Library screen (LIB-01, LIB-02, LIB-03):**
       - 4 category sections visible: Rain, Fire, Forest, Ocean
       - Each section scrolls horizontally â€” no "VirtualizedLists should never be nested" warning in Metro
       - At least 17 sound cards total across all sections
       - Each card shows: name, subtitle, duration, PRO badge on premium sounds

    3. **Navigation:**
       - 4-tab bar visible at bottom with frosted glass effect
       - Tapping graphic_eq tab shows "No sound playing" screen
       - Tapping Favorites tab shows empty state
       - Tapping Settings tab shows Settings screen

    4. **Player screen (VIS-01, VIS-02):**
       - Tap any sound card â†’ Player opens without tab bar visible
       - Ambient video (forest) plays in background
       - Top bar shows "NOW PLAYING" + sound name + back chevron
       - Bottom pill shows 4 icons (loop, cast, favorite, fullscreen)
       - Tap fullscreen icon â†’ top bar hides, pill hides, status bar hides
       - Only video and progress arc visible in fullscreen
       - Tap screen â†’ all controls restore
       - Tap back â†’ returns to library; no video audio continues

    5. **Dark mode (SET-01):**
       - Settings tab â†’ Dark Mode switch is ON
       - Toggle OFF â†’ Settings background changes from dark to light immediately
       - Navigate back to library â†’ library should also respond to theme (if wired)
       - Close and reopen app â†’ dark mode preference preserved
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Full phase verification after all tasks complete:

```bash
cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
# 1. TypeScript clean
npx tsc --noEmit 2>&1 | grep -v "^$" | head -20

# 2. Onboarding flag key consistent
grep -rn "has_seen_onboarding" app/ src/

# 3. Dark mode toggle wired
grep -n "toggleDarkMode" app/\(tabs\)/settings.tsx

# 4. Video pause in lifecycle
grep -n "player.pause" src/components/VideoBackground.tsx

# 5. Fullscreen keep-awake cleanup
grep -n "deactivateKeepAwake" app/player.tsx

# 6. No nested FlatList / ScrollView
grep -rn "ScrollView" app/\(tabs\)/index.tsx  # should be empty (using FlatList instead)
```
</verification>

<success_criteria>
Phase 3 complete when ALL are true:
1. First-time users see onboarding Welcome â†’ Quiet Mode â†’ Library (verified with fresh AsyncStorage)
2. Library shows 17+ sounds in 4 horizontal category sections â€” no VirtualizedList nesting warning
3. Each sound card shows name, subtitle, clip duration, and PRO badge for premium sounds
4. Tapping a sound opens the Player screen with no tab bar; ambient video plays muted and looped
5. Fullscreen button hides all UI chrome; tap anywhere restores; keep-awake is active during fullscreen
6. Navigating back from Player stops video audio (no bleed into library)
7. Dark mode toggle in Settings changes app background immediately and persists across app restarts
8. All files compile: `npx tsc --noEmit` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-ui/03-03-SUMMARY.md` documenting:
- Onboarding routing approach (AsyncStorage key, SplashScreen hold, router.replace timing)
- Which onboarding pitfalls from research were encountered (router.replace timing, useFocusEffect)
- Settings screen sections built and which controls are functional vs shell
- Dark mode: how theme is applied (per-screen inline vs context), what is and isn't themed in Phase 3
- Any deviations from this plan and why
</output>
