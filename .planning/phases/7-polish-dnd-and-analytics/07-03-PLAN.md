---
phase: 7-polish-dnd-and-analytics
plan: 03
type: execute
wave: 2
depends_on:
  - 07-01
  - 07-02
files_modified:
  - src/theme/contrast.spec.ts
  - docs/qa/phase-7-verification.md
  - scripts/profile-ios-memory.sh
  - scripts/verify-android-dnd.sh
autonomous: false
requirements:
  - VIS-03
  - ANLX-01

must_haves:
  truths:
    - "All interactive dark-mode UI tokens/components used in app satisfy WCAG AA 4.5:1 contrast minimum"
    - "A 15-minute iOS foreground playback profile completes with no upward memory growth trend"
    - "Android DND and analytics behavior are validated with reproducible QA steps and expected outputs"
  artifacts:
    - path: "src/theme/contrast.spec.ts"
      provides: "Automated contrast assertions for dark mode token pairs and key interactive components"
      contains: "toBeGreaterThanOrEqual(4.5)"
    - path: "scripts/profile-ios-memory.sh"
      provides: "Repeatable xctrace-based memory profiling script for 15-minute playback session"
      contains: "xctrace"
    - path: "docs/qa/phase-7-verification.md"
      provides: "Single source QA checklist for DND, analytics, contrast, and memory verification"
      min_lines: 60
  key_links:
    - from: "src/theme/contrast.spec.ts"
      to: "theme token source"
      via: "wcag-contrast checks against dark-mode text/background pairs"
      pattern: "wcag-contrast"
    - from: "scripts/profile-ios-memory.sh"
      to: "app/player.tsx"
      via: "launch and profile foreground playback scenario for 15 minutes"
      pattern: "15"
    - from: "docs/qa/phase-7-verification.md"
      to: "Firebase DebugView"
      via: "step-by-step KPI event validation matrix"
      pattern: "DebugView"
---

<objective>
Create hard verification gates for Phase 7: automated WCAG AA contrast tests, repeatable iOS memory profiling, and consolidated QA scripts/checklists for DND + analytics behavior.

Purpose: The phase goal requires measurable launch readiness, not informal spot checks. This plan converts quality expectations into repeatable gates before store submission.

Output: Contrast test suite, memory profiling script, Android DND verification script, and one QA runbook.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/7-polish-dnd-and-analytics/7-RESEARCH.md
@.planning/phases/7-polish-dnd-and-analytics/07-01-SUMMARY.md
@.planning/phases/7-polish-dnd-and-analytics/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add automated contrast and profiling scripts as release gates</name>
  <files>
    src/theme/contrast.spec.ts
    scripts/profile-ios-memory.sh
    scripts/verify-android-dnd.sh
  </files>
  <action>
Add `wcag-contrast` based tests covering dark-mode interactive text/background pairs used in buttons, tabs, badges, and settings rows. Each assertion must enforce `>= 4.5`.

Create `scripts/profile-ios-memory.sh` to run a reproducible 15-minute profile using `xctrace` Allocations/Leaks templates and export a timestamped trace artifact.

Create `scripts/verify-android-dnd.sh` for policy-access state check, filter apply/restore smoke verification, and output of current interruption filter before/after toggle.
  </action>
  <verify>
    Run test command covering `src/theme/contrast.spec.ts` and verify all assertions pass. Execute `scripts/profile-ios-memory.sh` on a connected iOS device and confirm a trace artifact is produced. Execute `scripts/verify-android-dnd.sh` on Android and confirm non-error exit.
  </verify>
  <done>
    - Contrast checks are automated and enforce WCAG AA threshold
    - iOS memory profile script can be rerun with consistent output artifacts
    - Android DND verification script validates apply/restore path in one pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Validate phase quality gates on real devices</name>
  <files>docs/qa/phase-7-verification.md</files>
  <action>
Draft a QA runbook consolidating exact steps and expected outcomes for: DND behavior by platform, six ANLX KPI events in DebugView, contrast signoff, and 15-minute memory profile acceptance.
  </action>
  <what-built>
    Automated contrast and profiling tooling plus platform verification scripts for VIS-03 and ANLX-01 readiness.
  </what-built>
  <how-to-verify>
    1. Run contrast tests and confirm all pass at >= 4.5:1.
    2. On Android: run DND toggle ON/OFF during active playback and verify restore semantics.
    3. On iOS: run Quiet Session toggle during active playback and validate partial behavior messaging.
    4. Trigger all six ANLX events and confirm they appear in Firebase DebugView.
    5. Run 15-minute iOS playback profile and confirm no sustained memory growth slope.
    6. Record outcomes in `docs/qa/phase-7-verification.md` and mark pass/fail per section.
  </how-to-verify>
  <verify>Human confirms all five validation areas pass or provides specific failures.</verify>
  <done>Phase 7 quality gates are executed and documented with explicit pass/fail outcomes.</done>
  <resume-signal>Type "approved" if all checks pass, or provide failing step numbers with notes.</resume-signal>
</task>

</tasks>

<verification>
Automated: contrast tests pass, scripts execute without runtime errors.
Manual: checkpoint approved with documented evidence for DND behavior, KPI events, and memory profile.
</verification>

<success_criteria>
- WCAG AA contrast gate exists and passes for dark-mode interactive UI tokens/components
- iOS 15-minute foreground playback memory profile is reproducible and acceptable
- Android and iOS DND/Quiet Session verification documented and approved
- ANLX KPI events verified in DebugView as part of QA runbook
</success_criteria>

<output>
After completion and checkpoint approval, create `.planning/phases/7-polish-dnd-and-analytics/07-03-SUMMARY.md` with test artifacts, trace references, and final gate results.
</output>
