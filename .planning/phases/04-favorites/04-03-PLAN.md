---
phase: 04-favorites
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - app/(tabs)/favorites.tsx
  - src/components/EmptyFavoritesState.tsx
  - app/(tabs)/settings.tsx
autonomous: false
requirements:
  - FAV-02
  - SET-03

must_haves:
  truths:
    - "The Favorites tab shows all saved sounds sorted most-recently-added first with no loading delay on open"
    - "The Favorites screen shows an illustrated empty state (not a blank screen) when no favorites exist"
    - "Favorites are present after closing and relaunching the app (persisted via store from Plan 04-01)"
    - "The empty state CTA 'Explore Sounds' navigates to the Library tab in one tap"
    - "The Settings screen Session Duration segmented control reads from and writes to uiStore.defaultTimerDuration"
    - "Selecting a different timer duration in Settings persists across app restarts"
    - "The dark mode toggle in Settings still works (not broken by Phase 4 changes)"
  artifacts:
    - path: "app/(tabs)/favorites.tsx"
      provides: "Favorites screen: FlatList of SoundCards sorted by addedAt desc, guarded by _hasHydrated, EmptyFavoritesState when empty"
      min_lines: 60
    - path: "src/components/EmptyFavoritesState.tsx"
      provides: "Illustrated empty state: heart icon, heading, subtext, 'Explore Sounds' CTA button navigating to index tab"
      min_lines: 50
    - path: "app/(tabs)/settings.tsx"
      provides: "Settings screen with Session Duration segmented control wired to uiStore.defaultTimerDuration (replaces local state sessionDuration)"
  key_links:
    - from: "app/(tabs)/favorites.tsx"
      to: "src/stores/favoritesStore.ts"
      via: "useFavoritesStore to read getSortedFavorites() and _hasHydrated"
      pattern: "useFavoritesStore.*getSortedFavorites|_hasHydrated"
    - from: "app/(tabs)/favorites.tsx"
      to: "src/components/EmptyFavoritesState.tsx"
      via: "FlatList ListEmptyComponent prop"
      pattern: "ListEmptyComponent.*EmptyFavoritesState"
    - from: "src/components/EmptyFavoritesState.tsx"
      to: "app/(tabs)/index.tsx"
      via: "router.push or Tabs navigation to library tab on CTA press"
      pattern: "router.*tabs|href.*index"
    - from: "app/(tabs)/settings.tsx"
      to: "src/stores/uiStore.ts"
      via: "useUIStore for defaultTimerDuration and setDefaultTimerDuration"
      pattern: "defaultTimerDuration|setDefaultTimerDuration"
---

<objective>
Build the Favorites screen with illustrated empty state and wire the Settings Session Duration control to uiStore. Followed by a human verification checkpoint of the complete Phase 4 experience.

Purpose: This plan closes out Phase 4 by delivering the visible Favorites screen (FAV-02) and completing the Settings screen (SET-03) with functional timer duration persistence. The human checkpoint confirms all 5 phase success criteria pass on device.
Output: Favorites screen, EmptyFavoritesState component, wired Settings screen, human verification of Phase 4.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-favorites/04-RESEARCH.md
@.planning/phases/04-favorites/04-01-SUMMARY.md
@app/(tabs)/favorites.tsx
@app/(tabs)/settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Favorites screen and EmptyFavoritesState component</name>
  <files>
    app/(tabs)/favorites.tsx
    src/components/EmptyFavoritesState.tsx
  </files>
  <action>
**Part A: Create EmptyFavoritesState component**

Create `src/components/EmptyFavoritesState.tsx` following `mock/empty_favorites_state/screen.png`.

Design tokens from mock:
- Background: transparent (screen background handles it)
- Large heart icon: `MaterialIcons name="favorite-border"` size 48, color `rgba(255,255,255,0.3)`, inside a 96×96 box with `backgroundColor: 'rgba(255,255,255,0.05)'`, `borderRadius: 24`, `borderWidth: 1`, `borderColor: 'rgba(255,255,255,0.1)'`
- Heading: "Your sanctuary is empty" — white, fontSize 20, fontWeight '600', textAlign center, marginTop 24
- Subtext: "Tap the heart icon on any sound to save your moments of peace here." — `rgba(255,255,255,0.5)`, fontSize 14, textAlign center, lineHeight 20, paddingHorizontal 32, marginTop 12
- CTA panel: a frosted-glass panel below the subtext (`backgroundColor: 'rgba(255,255,255,0.05)'`, borderRadius 16, padding 16, marginTop 32, marginHorizontal 24):
  - Row label: "Find your rhythm" (white, fontSize 15, fontWeight '500')
  - "Explore Sounds" button: `backgroundColor: '#ffffff'`, `borderRadius: 12`, `paddingVertical: 12`, `paddingHorizontal: 20`, text `#0f1115` (dark) fontSize 14 fontWeight '600'
  - Button onPress: navigate to the Library tab (index tab). Use `router.push('/(tabs)')` or `href={{ pathname: '/(tabs)' }}`. The correct approach for tab navigation in Expo Router is to use the `Tabs` navigator's exposed tab structure. Use `router.push('/')` or the Tabs object — test what works in the Expo Router version used. If the above fails, use `router.navigate('/(tabs)')`.

```typescript
// src/components/EmptyFavoritesState.tsx
import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';
import { MaterialIcons } from '@expo/vector-icons';
import { router } from 'expo-router';

export function EmptyFavoritesState() {
  return (
    <View style={styles.container}>
      {/* Heart icon box */}
      <View style={styles.iconBox}>
        <MaterialIcons name="favorite-border" size={48} color="rgba(255,255,255,0.3)" />
      </View>

      {/* Copy */}
      <Text style={styles.heading}>Your sanctuary is empty</Text>
      <Text style={styles.subtext}>
        Tap the heart icon on any sound to save your moments of peace here.
      </Text>

      {/* CTA panel */}
      <View style={styles.ctaPanel}>
        <Text style={styles.ctaLabel}>Find your rhythm</Text>
        <TouchableOpacity
          style={styles.ctaButton}
          onPress={() => router.push('/')}
          activeOpacity={0.85}
        >
          <Text style={styles.ctaButtonText}>Explore Sounds</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingHorizontal: 24,
    paddingBottom: 80, // account for tab bar height
  },
  iconBox: {
    width: 96,
    height: 96,
    borderRadius: 24,
    backgroundColor: 'rgba(255,255,255,0.05)',
    borderWidth: 1,
    borderColor: 'rgba(255,255,255,0.1)',
    alignItems: 'center',
    justifyContent: 'center',
  },
  heading: {
    color: '#ffffff',
    fontSize: 20,
    fontWeight: '600',
    textAlign: 'center',
    marginTop: 24,
  },
  subtext: {
    color: 'rgba(255,255,255,0.5)',
    fontSize: 14,
    textAlign: 'center',
    lineHeight: 20,
    paddingHorizontal: 8,
    marginTop: 12,
  },
  ctaPanel: {
    backgroundColor: 'rgba(255,255,255,0.05)',
    borderRadius: 16,
    padding: 16,
    marginTop: 32,
    width: '100%',
    alignItems: 'center',
    gap: 12,
  },
  ctaLabel: {
    color: '#ffffff',
    fontSize: 15,
    fontWeight: '500',
  },
  ctaButton: {
    backgroundColor: '#ffffff',
    borderRadius: 12,
    paddingVertical: 12,
    paddingHorizontal: 20,
  },
  ctaButtonText: {
    color: '#0f1115',
    fontSize: 14,
    fontWeight: '600',
  },
});
```

**Part B: Build Favorites screen**

Replace `app/(tabs)/favorites.tsx` (currently the Phase 3 empty state shell) with the full Favorites screen.

Key implementation rules from research:
- Wait for `_hasHydrated` before rendering — prevents flash of empty state on cold start. Return `null` until hydrated (not a loading spinner — just nothing, resolves in 50–200ms before user notices).
- Use `useMemo` on `getSortedFavorites()` to prevent new array reference on every render
- `contentContainerStyle={{ flexGrow: 1 }}` on FlatList ensures EmptyFavoritesState fills the screen when the list is empty
- The sound data for each favorite comes from the sound catalog — join `Favorite.id` to the sounds data to get the full Sound object for the SoundCard

Read `src/data/sounds.ts` (Phase 3) or `src/config/sounds.ts` (Phase 2) — whichever is the canonical sounds source — to understand how to look up a sound by ID. Use `SOUNDS_BY_ID` (Phase 2 catalog) or `SOUNDS.find()` (Phase 3 manifest) depending on which file is actually being used by the existing SoundCard.

```typescript
// app/(tabs)/favorites.tsx
import { useMemo } from 'react';
import { FlatList, View, Text, StyleSheet, SafeAreaView } from 'react-native';
import { useFavoritesStore } from '@/src/stores/favoritesStore';
import { SoundCard } from '@/src/components/SoundCard';
import { EmptyFavoritesState } from '@/src/components/EmptyFavoritesState';
// Import the sounds lookup — use whichever is canonical in the existing codebase:
// import { SOUNDS_BY_ID } from '@/src/config/sounds';   // Phase 2 catalog
// import { SOUNDS } from '@/src/data/sounds';           // Phase 3 manifest
// Determine which exists and import accordingly

export default function FavoritesScreen() {
  const favorites = useFavoritesStore((s) => s.favorites);
  const hasHydrated = useFavoritesStore((s) => s._hasHydrated);
  const getSortedFavorites = useFavoritesStore((s) => s.getSortedFavorites);

  // Guard: show nothing until AsyncStorage has rehydrated (50-200ms on cold start)
  // This prevents the flash of empty state even when favorites exist
  if (!hasHydrated) return null;

  // Memoize sorted array to prevent FlatList re-renders from new array reference
  // eslint-disable-next-line react-hooks/rules-of-hooks
  const sortedFavorites = useMemo(() => getSortedFavorites(), [favorites]);

  // Join favorite IDs to Sound objects for SoundCard
  // Adjust lookup based on the actual sounds source in this project
  const favoriteSounds = sortedFavorites
    .map((fav) => {
      // Use SOUNDS_BY_ID[fav.id] for Phase 2 catalog, or SOUNDS.find(s => s.id === fav.id) for Phase 3
      // Read the existing SoundCard import to determine which sounds source is canonical
      return null; // Replace with actual lookup
    })
    .filter(Boolean);

  return (
    <SafeAreaView style={styles.container}>
      <Text style={styles.screenTitle}>Your Favorites</Text>
      {sortedFavorites.length > 0 && (
        <Text style={styles.metaText}>{sortedFavorites.length} sounds saved</Text>
      )}
      <FlatList
        data={favoriteSounds}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => <SoundCard sound={item} />}
        ListEmptyComponent={<EmptyFavoritesState />}
        contentContainerStyle={[
          styles.listContent,
          favoriteSounds.length === 0 && styles.emptyContainer,
        ]}
        showsVerticalScrollIndicator={false}
      />
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#0f1115' },
  screenTitle: {
    color: '#ffffff',
    fontSize: 28,
    fontWeight: '700',
    paddingHorizontal: 24,
    paddingTop: 16,
    paddingBottom: 4,
  },
  metaText: {
    color: 'rgba(255,255,255,0.4)',
    fontSize: 13,
    paddingHorizontal: 24,
    marginBottom: 8,
  },
  listContent: {
    paddingHorizontal: 16,
    paddingBottom: 100, // account for frosted tab bar
    gap: 12,
  },
  emptyContainer: {
    flexGrow: 1, // allows EmptyFavoritesState to fill and center vertically
  },
});
```

IMPORTANT: The FlatList `data` must be the actual Sound objects (not just IDs) because `SoundCard` receives a `sound` prop. Before writing the final file, check how `SoundCard` is imported and used in the existing `index.tsx` to understand the exact prop shape, then pass the correct data type.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    # TypeScript check
    npx tsc --noEmit 2>&1 | grep -E "favorites|EmptyFavorites" | head -15

    # Verify _hasHydrated guard
    grep "_hasHydrated\|hasHydrated" app/\(tabs\)/favorites.tsx

    # Verify ListEmptyComponent wired
    grep "ListEmptyComponent.*EmptyFavoritesState" app/\(tabs\)/favorites.tsx

    # Verify contentContainerStyle has flexGrow (for empty state centering)
    grep "flexGrow" app/\(tabs\)/favorites.tsx

    # Verify EmptyFavoritesState has CTA navigation
    grep "router.push\|router.navigate\|Explore Sounds" src/components/EmptyFavoritesState.tsx

    # Verify useMemo on sorted favorites
    grep "useMemo" app/\(tabs\)/favorites.tsx
    ```
    TypeScript must pass. All guards and wiring must be present.
  </verify>
  <done>
    - `EmptyFavoritesState` component renders: heart icon box, heading, subtext, "Explore Sounds" CTA button
    - CTA button navigates to the Library tab (index tab) in one tap
    - Favorites screen returns `null` until `_hasHydrated` is `true` — no flash of empty state
    - FlatList renders SoundCards sorted most-recently-added first
    - `ListEmptyComponent={<EmptyFavoritesState />}` — illustrated empty state shown when list is empty
    - `contentContainerStyle` has `flexGrow: 1` on empty container so empty state centers vertically
    - `sortedFavorites` wrapped in `useMemo` to prevent unnecessary FlatList re-renders
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Settings Session Duration segmented control to uiStore.defaultTimerDuration</name>
  <files>
    app/(tabs)/settings.tsx
  </files>
  <action>
Read `app/(tabs)/settings.tsx` (built in Phase 3). The Phase 3 version has a `sessionDuration` local state variable (e.g., `useState('2m')`) driving the `SegmentedControl` in the PLAYBACK section. Phase 4 replaces this local state with the persisted `uiStore.defaultTimerDuration`.

Changes to make:

1. Add `useUIStore` import (may already be imported for dark mode toggle):
   ```typescript
   import { useUIStore } from '@/src/stores/uiStore';
   ```

2. In the component, destructure `defaultTimerDuration` and `setDefaultTimerDuration` from `useUIStore()`:
   ```typescript
   const { isDarkMode, _hasHydrated, toggleDarkMode, defaultTimerDuration, setDefaultTimerDuration } = useUIStore();
   ```

3. Remove the `const [sessionDuration, setSessionDuration] = useState('2m')` local state.

4. Update the `SegmentedControl` props in the Session Duration row:

   The Phase 3 `SegmentedControl` component in settings.tsx takes `options: string[]`, `selected: string`, and `onSelect: (v: string) => void`. Phase 4 must adapt the TimerDuration values (60 | 120 | 180 as numbers) to the string display ('1m' | '2m' | '3m') that the SegmentedControl expects.

   Define a mapping:
   ```typescript
   const TIMER_OPTIONS: { label: string; value: TimerDuration }[] = [
     { label: '1m', value: 60 },
     { label: '2m', value: 120 },
     { label: '3m', value: 180 },
   ];
   ```

   Then update the SegmentedControl:
   ```typescript
   <SegmentedControl
     options={TIMER_OPTIONS.map(o => o.label)}
     selected={TIMER_OPTIONS.find(o => o.value === defaultTimerDuration)?.label ?? '1m'}
     onSelect={(label) => {
       const option = TIMER_OPTIONS.find(o => o.label === label);
       if (option) setDefaultTimerDuration(option.value);
     }}
     isDark={isDarkMode}
   />
   ```

5. Add `import type { TimerDuration } from '@/src/types'` if not already imported.

6. The dark mode toggle section MUST remain unchanged — it was functional in Phase 3 and Phase 4 only changes the `isDarkMode` initial value in the store (done in Plan 04-01), not the Settings UI.

7. The account section placeholder: per research recommendation, do NOT add a greyed-out "Sign in to sync" row. Phase 5 adds auth; showing a disabled row in Phase 4 confuses users. Leave the Support section at the bottom as Phase 3 built it.

IMPORTANT: Before writing, read the actual settings.tsx to confirm:
- The exact SegmentedControl component props (options, selected, onSelect, isDark)
- The exact local state variable name for sessionDuration
- Whether useUIStore is already imported
Then make only the targeted changes — do not rewrite sections unrelated to Session Duration.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    # TypeScript check
    npx tsc --noEmit 2>&1 | grep "settings" | head -10

    # Verify defaultTimerDuration wired (not local state)
    grep "defaultTimerDuration" app/\(tabs\)/settings.tsx

    # Verify setDefaultTimerDuration called from SegmentedControl
    grep "setDefaultTimerDuration" app/\(tabs\)/settings.tsx

    # Verify local sessionDuration state removed
    grep "sessionDuration" app/\(tabs\)/settings.tsx && echo "WARNING: local state may still exist" || echo "OK: removed"

    # Dark mode toggle still wired (not broken)
    grep "toggleDarkMode\|isDarkMode" app/\(tabs\)/settings.tsx

    # No account placeholder row added
    grep -i "sign in\|account\|sync" app/\(tabs\)/settings.tsx && echo "NOTE: account row may be present" || echo "OK: no account row"
    ```
    TypeScript must pass. Session Duration control wired to store. Dark mode toggle preserved. No account placeholder row.
  </verify>
  <done>
    - Session Duration `SegmentedControl` in Settings reads `defaultTimerDuration` from `useUIStore`
    - Selecting a duration calls `setDefaultTimerDuration(value)` — persisted to AsyncStorage
    - Local `sessionDuration` state variable removed
    - Dark mode toggle unchanged and still functional
    - No account placeholder row added (deferred to Phase 5)
    - `TimerDuration` type imported
    - No TypeScript errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Phase 4 Favorites end-to-end on device</name>
  <action>No automated action — this checkpoint requires human verification of the Phase 4 feature set on a simulator or device.</action>
  <what-built>
    Complete Phase 4 Favorites:
    - 04-01: favoritesStore upgraded to Favorite[] with persist, uiStore defaultTimerDuration, LocalFavoritesAdapter
    - 04-02: FavoriteButton component (spring animation), heart on SoundCard and player, timer pre-fill and coupling
    - 04-03: Favorites screen (sorted FlatList + illustrated empty state), Settings Session Duration wired to uiStore
  </what-built>
  <how-to-verify>
    Run the app on a simulator or device:
    ```bash
    npx expo start
    ```

    Test each Phase 4 success criterion:

    **1. FAV-01 — Heart toggle on library cards:**
    - Open the Library tab — each SoundCard should show a heart icon (outlined, grey)
    - Tap the heart on any sound — heart should fill rose-pink with a brief pop animation
    - Tap the same heart again — heart should return to outlined grey (immediate, no confirmation)
    - Repeat with 2-3 more sounds — each should toggle independently

    **2. FAV-01 — Heart toggle on player screen:**
    - Tap any sound to open the Player
    - The heart icon in the player controls should reflect the correct favorite status
    - Tap the heart in the player — status should change and match what the library card shows

    **3. FAV-02 — Favorites screen with content:**
    - After favoriting 2-3 sounds, open the Favorites tab
    - All favorited sounds should appear as cards (most recently added first)
    - A "X sounds saved" count should appear above the list

    **4. FAV-02 — Favorites persist across restart:**
    - With favorites saved, close the app completely (force-quit on iOS or Android)
    - Relaunch — Favorites tab should still show the same sounds (AsyncStorage persisted)
    - The Favorites tab must NOT flash an empty state before showing the list

    **5. FAV-02 — Empty state:**
    - Remove all favorites (tap each heart to un-favorite)
    - Open the Favorites tab — should show the illustrated empty state:
      - Outlined heart icon in a box
      - "Your sanctuary is empty" heading
      - Subtext about tapping the heart
      - "Explore Sounds" button
    - Tap "Explore Sounds" — should navigate to the Library tab

    **6. SET-02 — Default timer in Settings:**
    - Open Settings tab
    - Session Duration control should show 3 options (1m, 2m, 3m), with 1m selected (or last selected)
    - Tap 3m — it should highlight as selected
    - Force-quit and relaunch app
    - Open Settings — 3m should still be selected (persisted)

    **7. SET-02 — Timer pre-fill in player:**
    - With default set to 3m in Settings, open any sound in the Player
    - The timer display should show 3:00 (pre-filled from default)
    - Change the timer in the player to 1m
    - Exit player, open Settings — Session Duration should now show 1m (coupling worked)

    **8. SET-03 — Settings screen reachable:**
    - Settings tab is visible in the bottom nav bar
    - Dark mode toggle is still functional (toggle it — should change app background immediately)
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After Tasks 1 and 2 complete (before checkpoint):

```bash
cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
# Full TypeScript clean
npx tsc --noEmit

# Hydration guard in place
grep "_hasHydrated\|hasHydrated" app/\(tabs\)/favorites.tsx

# Empty state wired
grep "ListEmptyComponent" app/\(tabs\)/favorites.tsx

# Timer wired in settings
grep "defaultTimerDuration\|setDefaultTimerDuration" app/\(tabs\)/settings.tsx

# FavoriteButton on cards and player (from Plan 04-02)
grep "FavoriteButton" src/components/SoundCard.tsx app/player.tsx

# Verify no old string[] shape anywhere
grep -rn "favoriteIds" src/ app/ --include="*.ts" --include="*.tsx"
# Expected: 0 results
```
</verification>

<success_criteria>
Phase 4 complete when ALL are true:
1. Tapping heart on any SoundCard or player immediately toggles favorite status with visible pop animation
2. Favorites screen shows all saved sounds (most recently added first) with no loading delay on open
3. Favorites persist across app close and relaunch — no flash of empty state before list appears
4. Empty state screen shows illustrated heart icon, "Your sanctuary is empty" heading, and "Explore Sounds" CTA
5. Settings Session Duration control reads from and writes to `uiStore.defaultTimerDuration` (persisted)
6. Dark mode toggle in Settings still functional (not regressed by Phase 4 changes)
7. All files compile: `npx tsc --noEmit` exits 0
8. Human checkpoint: approved
</success_criteria>

<output>
After completion (including checkpoint approval), create `.planning/phases/04-favorites/04-03-SUMMARY.md` documenting:
- Favorites screen: sounds lookup approach used, FlatList config, empty state centering solution
- EmptyFavoritesState: CTA navigation approach for tab switching
- Settings: how TimerDuration numbers were mapped to '1m'/'2m'/'3m' labels for the segmented control
- Hydration flash: was the null guard sufficient or was a shimmer needed?
- Any issues found during human checkpoint and how they were resolved
- Any deviations from this plan and why
</output>
