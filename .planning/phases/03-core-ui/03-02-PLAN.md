---
phase: 03-core-ui
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - app/player.tsx
  - src/components/VideoBackground.tsx
  - src/components/CircularProgressArc.tsx
  - src/components/BottomControlPill.tsx
autonomous: true
requirements:
  - VIS-01
  - VIS-02

must_haves:
  truths:
    - "Tapping a sound card navigates to the Player screen — a fullscreen view with no tab bar visible"
    - "The ambient video (forest.mp4) plays looping and muted behind all controls"
    - "The circular progress arc around the play button reflects a progress value (static/full in Phase 3 before audio integration)"
    - "The bottom frosted-glass control pill shows: loop, airplay, favorite, fullscreen icons"
    - "Tapping the fullscreen button hides the top bar and bottom pill — only video and audio remain visible"
    - "Tapping anywhere on the screen while in fullscreen restores all controls"
    - "Navigating back to the library stops the video (no audio bleed from expo-video)"
    - "Screen does not sleep during fullscreen mode (keep-awake active)"
  artifacts:
    - path: "app/player.tsx"
      provides: "Fullscreen player screen: VideoBackground + top bar + CircularProgressArc + BottomControlPill, fullscreen mode toggle logic"
      min_lines: 100
    - path: "src/components/VideoBackground.tsx"
      provides: "expo-video VideoView wrapper: player.loop=true, player.muted=true, useFocusEffect pause/play lifecycle"
      exports: ["VideoBackground"]
    - path: "src/components/CircularProgressArc.tsx"
      provides: "SVG Circle arc with strokeDashoffset driven by progress (0-1 SharedValue), centered play/pause button, countdown timer text"
      exports: ["CircularProgressArc"]
    - path: "src/components/BottomControlPill.tsx"
      provides: "Frosted BlurView pill with loop, airplay, favorite, fullscreen icon buttons"
      exports: ["BottomControlPill"]
  key_links:
    - from: "app/player.tsx"
      to: "src/components/VideoBackground.tsx"
      via: "renders VideoBackground with category video source"
      pattern: "VideoBackground"
    - from: "app/player.tsx"
      to: "expo-status-bar setStatusBarHidden"
      via: "enterFullscreen / exitFullscreen functions"
      pattern: "setStatusBarHidden"
    - from: "app/player.tsx"
      to: "expo-keep-awake activateKeepAwakeAsync"
      via: "enterFullscreen"
      pattern: "activateKeepAwakeAsync"
    - from: "src/components/VideoBackground.tsx"
      to: "useFocusEffect cleanup"
      via: "player.pause() in return callback"
      pattern: "player\\.pause"
    - from: "src/components/CircularProgressArc.tsx"
      to: "react-native-svg AnimatedCircle"
      via: "strokeDashoffset animatedProps"
      pattern: "strokeDashoffset"
    - from: "src/components/BottomControlPill.tsx"
      to: "expo-blur BlurView"
      via: "pill container background"
      pattern: "BlurView"
---

<objective>
Build the Player screen and its three sub-components: VideoBackground (looping muted ambient video), CircularProgressArc (SVG progress ring around play button), and BottomControlPill (frosted-glass controls). Implement fullscreen immersive mode: tap fullscreen button to hide all UI chrome, tap anywhere to restore.

Purpose: This is the core user experience moment — the screen users spend time on. All visual decisions (ambient video, frosted controls, fullscreen calm) land here.
Output: A working Player screen that shows ambient video, controls, and toggles into true fullscreen immersive mode with keep-awake.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-ui/03-RESEARCH.md
@.planning/phases/03-core-ui/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: VideoBackground component with expo-video lifecycle</name>
  <files>
    src/components/VideoBackground.tsx
  </files>
  <action>
Create `src/components/VideoBackground.tsx`. This component wraps `expo-video`'s `VideoView` and handles the muted looping background with proper iOS lifecycle management.

CRITICAL requirements (from research):
- `player.muted = true` — ALWAYS. Video audio conflicts with expo-audio audio session from Phase 2.
- `player.loop = true` — ambient video loops indefinitely.
- `useFocusEffect` with `player.pause()` in cleanup — prevents iOS audio-continues-after-unmount bug (Pitfall 1 in research).
- `nativeControls={false}` — no video controls UI.
- `allowsFullscreen={false}` — use custom fullscreen, not OS video fullscreen.
- `contentFit="cover"` — fill the screen edge to edge.

```typescript
import { StyleSheet } from 'react-native';
import { useVideoPlayer, VideoView } from 'expo-video';
import { useFocusEffect } from 'expo-router';
import { useCallback } from 'react';

interface VideoBackgroundProps {
  source: number | string; // require() for local assets or URI string
}

export function VideoBackground({ source }: VideoBackgroundProps) {
  const player = useVideoPlayer(source, (p) => {
    p.loop = true;
    p.muted = true; // REQUIRED: do not conflict with expo-audio
    p.play();
  });

  // Pause on screen blur, resume on focus — prevents iOS audio-continues-after-unmount bug
  useFocusEffect(
    useCallback(() => {
      player.play();
      return () => {
        player.pause(); // CRITICAL: explicit pause in cleanup
      };
    }, [player])
  );

  return (
    <VideoView
      player={player}
      style={StyleSheet.absoluteFill}
      contentFit="cover"
      nativeControls={false}
      allowsFullscreen={false}
    />
  );
}
```

The `source` prop will receive `require('../../background_video/forest.mp4')` from the player screen. Check that the forest.mp4 file exists at `background_video/forest.mp4` relative to the project root. If it exists in a different location, adjust the path in the player screen (not in this component).
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    npx tsc --noEmit 2>&1 | grep VideoBackground | head -10
    ```
    No TypeScript errors. File exists and exports VideoBackground.
  </verify>
  <done>
    - VideoBackground.tsx exists and exports `VideoBackground` function component
    - player.muted = true is set in useVideoPlayer initializer
    - useFocusEffect returns a cleanup that calls player.pause()
    - nativeControls={false} and allowsFullscreen={false} are set on VideoView
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: CircularProgressArc and BottomControlPill components</name>
  <files>
    src/components/CircularProgressArc.tsx
    src/components/BottomControlPill.tsx
  </files>
  <action>
1. Create `src/components/CircularProgressArc.tsx`:

   This component renders a thin SVG arc ring around a central play/pause button. In Phase 3, the arc is driven by a static progress value (full circle = timer not yet wired). The play button is a visual-only button that toggles play/pause state in audioStore.

   The arc uses `react-native-svg` `Circle` with `strokeDashoffset` animated via `react-native-reanimated` `useAnimatedProps`. Requires wrapping Circle in `Animated.createAnimatedComponent`.

   From research: RADIUS=46, CIRCUMFERENCE = 2 * Math.PI * 46 ≈ 289. Arc rotated -90deg so it starts from the top.

   ```typescript
   import { View, TouchableOpacity, Text, StyleSheet } from 'react-native';
   import Svg, { Circle } from 'react-native-svg';
   import Animated, { useAnimatedProps, useSharedValue } from 'react-native-reanimated';
   import { MaterialIcons } from '@expo/vector-icons';

   const AnimatedCircle = Animated.createAnimatedComponent(Circle);

   const RADIUS = 46;
   const CIRCUMFERENCE = 2 * Math.PI * RADIUS;
   const SVG_SIZE = 200;

   interface CircularProgressArcProps {
     progress: number;        // 0 to 1; 1 = full circle (beginning of timer), 0 = empty (complete)
     isPlaying: boolean;
     onPlayPause: () => void;
     timerLabel: string;      // e.g. "2:00" or "1:43" — displayed below play button
   }

   export function CircularProgressArc({
     progress,
     isPlaying,
     onPlayPause,
     timerLabel,
   }: CircularProgressArcProps) {
     // In Phase 3, use a regular shared value since audioStore timer isn't connected yet
     const progressSV = useSharedValue(progress);
     progressSV.value = progress;

     const animatedProps = useAnimatedProps(() => ({
       strokeDashoffset: CIRCUMFERENCE * (1 - progressSV.value),
     }));

     return (
       <View style={styles.container}>
         {/* SVG arc ring */}
         <Svg
           width={SVG_SIZE}
           height={SVG_SIZE}
           viewBox="0 0 100 100"
           style={styles.svg}
         >
           {/* Track circle (background ring) */}
           <Circle
             cx={50}
             cy={50}
             r={RADIUS}
             stroke="rgba(255,255,255,0.12)"
             strokeWidth={0.6}
             fill="none"
           />
           {/* Progress arc */}
           <AnimatedCircle
             cx={50}
             cy={50}
             r={RADIUS}
             stroke="rgba(255,255,255,0.85)"
             strokeWidth={0.8}
             strokeLinecap="round"
             strokeDasharray={CIRCUMFERENCE}
             animatedProps={animatedProps}
             fill="none"
           />
         </Svg>

         {/* Play/Pause button centered over SVG */}
         <TouchableOpacity
           onPress={onPlayPause}
           style={styles.playButton}
           activeOpacity={0.7}
         >
           <MaterialIcons
             name={isPlaying ? 'pause' : 'play-arrow'}
             size={48}
             color="#ffffff"
           />
         </TouchableOpacity>

         {/* Timer label below */}
         <Text style={styles.timerLabel}>{timerLabel}</Text>
       </View>
     );
   }

   const styles = StyleSheet.create({
     container: {
       alignItems: 'center',
       justifyContent: 'center',
     },
     svg: {
       transform: [{ rotate: '-90deg' }],
     },
     playButton: {
       position: 'absolute',
       alignItems: 'center',
       justifyContent: 'center',
       width: 80,
       height: 80,
     },
     timerLabel: {
       color: 'rgba(255,255,255,0.7)',
       fontSize: 16,
       fontWeight: '200',
       marginTop: 16,
       letterSpacing: 2,
     },
   });
   ```

2. Create `src/components/BottomControlPill.tsx`:

   Frosted-glass horizontal pill with 4 icon buttons: loop, airplay, favorite, fullscreen.
   - Pill shape: `BlurView` with `tint="dark"`, `intensity={70}`, `experimentalBlurMethod="dimezisBlurView"`, `borderRadius: 50`, `paddingHorizontal: 28`, `paddingVertical: 16`
   - 4 icons spread horizontally with `justifyContent: 'space-between'`
   - Icons: loop → `MaterialIcons "loop"`, airplay → `MaterialIcons "airplay"` or `"cast"`, favorite → `MaterialIcons "favorite-border"`, fullscreen → `MaterialIcons "fullscreen"`
   - Each icon is a TouchableOpacity; only `onFullscreen` and `onLoop` have real callbacks in Phase 3; `onAirplay` and `onFavorite` are no-ops (Phase 4/6)
   - Active state for loop: if `loopActive` prop is true, tint the loop icon purple (`#8b5cf6`)

   ```typescript
   import { View, TouchableOpacity, StyleSheet } from 'react-native';
   import { BlurView } from 'expo-blur';
   import { MaterialIcons } from '@expo/vector-icons';

   interface BottomControlPillProps {
     loopActive: boolean;
     onLoop: () => void;
     onFullscreen: () => void;
   }

   export function BottomControlPill({ loopActive, onLoop, onFullscreen }: BottomControlPillProps) {
     return (
       <BlurView
         tint="dark"
         intensity={70}
         experimentalBlurMethod="dimezisBlurView"
         style={styles.pill}
       >
         <TouchableOpacity onPress={onLoop} style={styles.iconButton}>
           <MaterialIcons
             name="loop"
             size={24}
             color={loopActive ? '#8b5cf6' : 'rgba(255,255,255,0.7)'}
           />
         </TouchableOpacity>
         <TouchableOpacity style={styles.iconButton} onPress={() => {}}>
           <MaterialIcons name="cast" size={24} color="rgba(255,255,255,0.7)" />
         </TouchableOpacity>
         <TouchableOpacity style={styles.iconButton} onPress={() => {}}>
           <MaterialIcons name="favorite-border" size={24} color="rgba(255,255,255,0.7)" />
         </TouchableOpacity>
         <TouchableOpacity onPress={onFullscreen} style={styles.iconButton}>
           <MaterialIcons name="fullscreen" size={24} color="rgba(255,255,255,0.7)" />
         </TouchableOpacity>
       </BlurView>
     );
   }

   const styles = StyleSheet.create({
     pill: {
       flexDirection: 'row',
       justifyContent: 'space-between',
       alignItems: 'center',
       borderRadius: 50,
       paddingHorizontal: 28,
       paddingVertical: 16,
       overflow: 'hidden',
       minWidth: 240,
     },
     iconButton: {
       padding: 8,
     },
   });
   ```
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    npx tsc --noEmit 2>&1 | grep -E "CircularProgress|BottomControl" | head -10
    ```
    Both files compile without errors. Exports are named (not default).
  </verify>
  <done>
    - CircularProgressArc.tsx: SVG arc with AnimatedCircle using strokeDashoffset, central play/pause TouchableOpacity, timer label text
    - BottomControlPill.tsx: BlurView frosted pill with 4 icon buttons; fullscreen and loop have real callbacks; airplay and favorite are no-ops
    - Both export named components (not default exports)
    - No TypeScript errors in either file
  </done>
</task>

<task type="auto">
  <name>Task 3: Player screen with fullscreen immersive mode</name>
  <files>
    app/player.tsx
  </files>
  <action>
Create `app/player.tsx` — the fullscreen player screen. This screen renders outside the tab navigator (it is a sibling of `(tabs)` in the root Stack), so no tab bar is visible.

Key behaviors:
1. Reads `soundId` from route params to identify which sound is playing
2. Renders VideoBackground with forest.mp4 (placeholder for all categories in Phase 3)
3. Shows top bar with back chevron, "NOW PLAYING" label, sound name, and ••• menu button
4. Shows CircularProgressArc with static full progress (1.0) and play/pause toggle
5. Shows BottomControlPill with loop and fullscreen buttons
6. Fullscreen mode toggle: hides top bar and bottom pill, hides status bar, activates keep-awake
7. Tap anywhere to restore from fullscreen
8. Cleans up keep-awake on unmount

```typescript
import {
  View,
  Text,
  TouchableOpacity,
  TouchableWithoutFeedback,
  StyleSheet,
  SafeAreaView,
} from 'react-native';
import { router, useLocalSearchParams } from 'expo-router';
import { useState, useCallback } from 'react';
import { setStatusBarHidden } from 'expo-status-bar';
import { activateKeepAwakeAsync, deactivateKeepAwake } from 'expo-keep-awake';
import { useFocusEffect } from 'expo-router';
import { MaterialIcons } from '@expo/vector-icons';
import { VideoBackground } from '@/src/components/VideoBackground';
import { CircularProgressArc } from '@/src/components/CircularProgressArc';
import { BottomControlPill } from '@/src/components/BottomControlPill';
import { SOUNDS } from '@/src/data/sounds';

const KEEP_AWAKE_TAG = 'fullscreen-player';
// forest.mp4 is the only video asset in Phase 3; used as placeholder for all categories
const FOREST_VIDEO = require('../background_video/forest.mp4');

export default function PlayerScreen() {
  const { soundId } = useLocalSearchParams<{ soundId: string }>();
  const sound = SOUNDS.find((s) => s.id === soundId) ?? SOUNDS[0];

  const [isFullscreen, setIsFullscreen] = useState(false);
  const [isPlaying, setIsPlaying] = useState(true);
  const [loopActive, setLoopActive] = useState(false);

  // Clean up keep-awake when screen loses focus (navigate away or app goes to background)
  useFocusEffect(
    useCallback(() => {
      return () => {
        // Always clean up keep-awake on screen blur
        deactivateKeepAwake(KEEP_AWAKE_TAG);
        // Restore status bar if fullscreen was active when user navigated away
        setStatusBarHidden(false, 'fade');
      };
    }, [])
  );

  function enterFullscreen() {
    setStatusBarHidden(true, 'fade');
    activateKeepAwakeAsync(KEEP_AWAKE_TAG);
    setIsFullscreen(true);
  }

  function exitFullscreen() {
    setStatusBarHidden(false, 'fade');
    deactivateKeepAwake(KEEP_AWAKE_TAG);
    setIsFullscreen(false);
  }

  function handlePlayPause() {
    setIsPlaying((prev) => !prev);
    // Phase 2 audio engine: call audioStore play/pause here once wired
  }

  function handleLoop() {
    setLoopActive((prev) => !prev);
    // Phase 2 audio engine: toggle loop in audioStore once wired
  }

  // In fullscreen: tap anywhere restores controls
  // Not in fullscreen: taps do nothing (handled by individual buttons)
  function handleScreenTap() {
    if (isFullscreen) {
      exitFullscreen();
    }
  }

  // Progress: Phase 3 shows full arc (1.0); wired to audioStore.timerRemaining in Phase 4
  const progress = 1.0;
  const timerLabel = sound.duration;

  return (
    <TouchableWithoutFeedback onPress={handleScreenTap}>
      <View style={styles.container}>
        {/* Ambient video background — fills entire screen */}
        <VideoBackground source={FOREST_VIDEO} />

        {/* Dark scrim over video so controls are readable */}
        <View style={styles.scrim} />

        {/* Top bar — hidden in fullscreen */}
        {!isFullscreen && (
          <SafeAreaView style={styles.topBar}>
            <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
              <MaterialIcons name="chevron-left" size={28} color="#ffffff" />
            </TouchableOpacity>
            <View style={styles.topCenter}>
              <Text style={styles.nowPlayingLabel}>NOW PLAYING</Text>
              <Text style={styles.soundName} numberOfLines={1}>{sound.name}</Text>
            </View>
            <TouchableOpacity style={styles.moreButton}>
              <Text style={styles.moreIcon}>•••</Text>
            </TouchableOpacity>
          </SafeAreaView>
        )}

        {/* Center: circular progress arc + play button */}
        <View style={styles.center}>
          <CircularProgressArc
            progress={progress}
            isPlaying={isPlaying}
            onPlayPause={handlePlayPause}
            timerLabel={timerLabel}
          />
        </View>

        {/* Bottom control pill — hidden in fullscreen */}
        {!isFullscreen && (
          <View style={styles.bottomArea}>
            <BottomControlPill
              loopActive={loopActive}
              onLoop={handleLoop}
              onFullscreen={enterFullscreen}
            />
          </View>
        )}
      </View>
    </TouchableWithoutFeedback>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#0f1115',
  },
  scrim: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: 'rgba(0,0,0,0.35)',
  },
  topBar: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingTop: 8,
    zIndex: 10,
  },
  backButton: {
    padding: 8,
  },
  topCenter: {
    flex: 1,
    alignItems: 'center',
  },
  nowPlayingLabel: {
    color: 'rgba(255,255,255,0.5)',
    fontSize: 10,
    fontWeight: '600',
    letterSpacing: 2,
  },
  soundName: {
    color: '#ffffff',
    fontSize: 16,
    fontWeight: '300',
    marginTop: 2,
  },
  moreButton: {
    padding: 8,
  },
  moreIcon: {
    color: 'rgba(255,255,255,0.7)',
    fontSize: 14,
    letterSpacing: 1,
  },
  center: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 10,
  },
  bottomArea: {
    alignItems: 'center',
    paddingBottom: 60,
    zIndex: 10,
  },
});
```

Verify the background_video path: check whether forest.mp4 is at `background_video/forest.mp4` (relative to project root). The require path in `app/player.tsx` would be `require('../background_video/forest.mp4')`. If the file is at a different path, adjust accordingly.

If `@expo/vector-icons` is not installed, check if it is bundled with expo (it is part of the default Expo SDK). Use `import { MaterialIcons } from '@expo/vector-icons'`.
  </action>
  <verify>
    ```bash
    cd /Users/manuelfrancogiraldez/Documents/2026/proyectos/calm-asmr-sounds
    npx tsc --noEmit 2>&1 | grep player | head -10
    ls background_video/
    ```
    TypeScript passes. forest.mp4 file exists in background_video/ directory.

    Manual verification (run on device/simulator):
    1. Launch app → tap any sound card → Player screen opens without tab bar visible
    2. Video plays in background (muted — no video audio heard)
    3. Top bar shows "NOW PLAYING" + sound name, back button works
    4. Bottom pill shows 4 icons
    5. Tap fullscreen icon → top bar hides, pill hides, status bar hides → only video + center arc visible
    6. Tap screen → controls restore
    7. Navigate back → no video audio continues playing in library
  </verify>
  <done>
    - app/player.tsx renders fullscreen with VideoBackground, top bar, CircularProgressArc, BottomControlPill
    - Fullscreen toggle: enterFullscreen hides top bar + pill + status bar + activates keep-awake; exitFullscreen restores all
    - Tap anywhere while fullscreen calls exitFullscreen
    - useFocusEffect cleanup deactivates keep-awake and restores status bar on navigation away
    - Back button calls router.back() to return to library
    - No TypeScript errors
    - No tab bar visible on this screen (confirmed by root Stack sibling structure from 03-01)
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify full plan outcome:

1. `npx tsc --noEmit` passes with no errors in any of the 4 files modified
2. VideoBackground pauses video in useFocusEffect cleanup (`grep -n "player.pause" src/components/VideoBackground.tsx` → finds the line)
3. CircularProgressArc uses AnimatedCircle with strokeDashoffset (`grep -n "strokeDashoffset" src/components/CircularProgressArc.tsx` → found)
4. Player fullscreen mode: `grep -n "setStatusBarHidden\|activateKeepAwake" app/player.tsx` → both appear
5. Player screen back button is present (`grep -n "router.back" app/player.tsx` → found)
6. On-device: play a sound, enter fullscreen, confirm only video visible; tap to restore; navigate back and confirm no video audio leak
</verification>

<success_criteria>
- Tapping a sound in the library navigates to the Player screen (no tab bar)
- Ambient video loops muted behind the controls
- Fullscreen button hides all chrome; tap-to-restore works
- Keep-awake activates on fullscreen entry; deactivates on fullscreen exit AND on navigation away
- Back button returns to library; no video audio continues after leaving the player
- All 4 files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-ui/03-02-SUMMARY.md` documenting:
- VideoBackground: mute/loop/lifecycle approach, exact useFocusEffect pattern used
- CircularProgressArc: SVG dimensions, RADIUS, CIRCUMFERENCE values used
- BottomControlPill: BlurView intensity setting, which icons are no-ops vs functional
- Player fullscreen: state management approach (local state vs uiStore), keep-awake tag
- Any expo-video iOS audio-after-unmount issue observed and how it was handled
- Video asset path confirmed (background_video/forest.mp4)
- Any deviations from this plan and why
</output>
