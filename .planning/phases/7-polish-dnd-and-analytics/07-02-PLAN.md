---
phase: 7-polish-dnd-and-analytics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constants/analyticsEvents.ts
  - src/services/AnalyticsService.ts
  - src/hooks/useTrackKpiEvents.ts
  - app/player.tsx
  - src/components/FavoriteButton.tsx
  - src/services/PremiumPaywallService.ts
  - src/stores/audioStore.ts
autonomous: true
requirements:
  - ANLX-01

must_haves:
  truths:
    - "When user plays a sound, a sound_played analytics event is emitted with stable params"
    - "When user saves a favorite, a favorite_saved event is emitted"
    - "When user enables loop or sets a timer, loop_enabled and timer_set events are emitted"
    - "When paywall is shown and purchase succeeds, paywall_viewed and subscription_purchased events are emitted"
    - "All KPI events can be validated in Firebase DebugView with no event-name drift"
  artifacts:
    - path: "src/constants/analyticsEvents.ts"
      provides: "Canonical event names and param schemas for all ANLX-01 KPI events"
      contains: "sound_played"
    - path: "src/services/AnalyticsService.ts"
      provides: "Typed wrapper over @react-native-firebase/analytics with guarded logEvent entrypoint"
      exports: ["AnalyticsService"]
    - path: "src/hooks/useTrackKpiEvents.ts"
      provides: "Hook helpers for playback/session UI call sites to keep screens lean"
      exports: ["useTrackKpiEvents"]
    - path: "src/services/PremiumPaywallService.ts"
      provides: "paywall_viewed and subscription_purchased instrumentation around paywall result flow"
      contains: "subscription_purchased"
  key_links:
    - from: "src/services/AnalyticsService.ts"
      to: "@react-native-firebase/analytics"
      via: "single log gateway; no direct analytics() usage elsewhere"
      pattern: "logEvent"
    - from: "app/player.tsx"
      to: "src/hooks/useTrackKpiEvents.ts"
      via: "player action handlers call typed tracking helpers"
      pattern: "trackSoundPlayed"
    - from: "src/components/FavoriteButton.tsx"
      to: "src/services/AnalyticsService.ts"
      via: "favorite save action logs favorite_saved"
      pattern: "favorite_saved"
---

<objective>
Implement ANLX-01 with a typed analytics gateway and deterministic instrumentation at all KPI points: sound played, favorite saved, loop enabled, timer set, paywall viewed, and subscription purchased.

Purpose: Analytics correctness fails when events are logged ad hoc. This plan enforces one event catalog and one service so downstream dashboards remain trustworthy.

Output: RN Firebase analytics integration with typed event wrappers and KPI instrumentation in existing flows.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/7-polish-dnd-and-analytics/7-RESEARCH.md
@.planning/phases/06-freemium-and-monetization/06-01-SUMMARY.md
@.planning/phases/06-freemium-and-monetization/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create typed event catalog and AnalyticsService gateway</name>
  <files>
    src/constants/analyticsEvents.ts
    src/services/AnalyticsService.ts
    src/hooks/useTrackKpiEvents.ts
  </files>
  <action>
Install and use `@react-native-firebase/analytics` (not Firebase JS analytics). Add a canonical event map with exactly these event IDs: `sound_played`, `favorite_saved`, `loop_enabled`, `timer_set`, `paywall_viewed`, `subscription_purchased`.

Implement `AnalyticsService.track(event, params)` with runtime guards for unsupported event names and basic param sanitization. Export dedicated helper methods for each KPI event to avoid raw string usage at call sites.

Create `useTrackKpiEvents` hook that exposes domain helpers for player/favorites/paywall flows. Keep event name definitions out of components.
  </action>
  <verify>
    Run `npx tsc --noEmit` with 0 errors. Verify `src/constants/analyticsEvents.ts` contains all six ANLX-01 events and verify there are no direct imports of `@react-native-firebase/analytics` outside `src/services/AnalyticsService.ts`.
  </verify>
  <done>
    - Event taxonomy is centralized and typed
    - `AnalyticsService` is the only place calling native Firebase analytics SDK
    - Hook helpers exist for KPI-oriented usage in UI/services
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire KPI events into player, favorites, loop/timer, and paywall flows</name>
  <files>
    app/player.tsx
    src/components/FavoriteButton.tsx
    src/services/PremiumPaywallService.ts
    src/stores/audioStore.ts
  </files>
  <action>
Instrument KPI events at existing user actions only (no synthetic/background spam):
- `sound_played` when playback starts from user action
- `favorite_saved` on successful favorite add action
- `loop_enabled` when loop is turned on
- `timer_set` when user sets timer duration
- `paywall_viewed` when paywall is actually presented
- `subscription_purchased` on successful paywall purchase result

Ensure events use stable params (`sound_id`, `category`, `timer_seconds`, `source_screen`, `platform`) where available and avoid PII.

Add lightweight dedupe for rapid repeated taps in the same UI frame where needed, but do not suppress legitimate repeated actions across sessions.
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm 0 errors. Validate event calls by searching for all six canonical IDs in modified files. Confirm Android DebugView setup command works: `adb shell setprop debug.firebase.analytics.app <applicationId>` and verify events appear during manual run.
  </verify>
  <done>
    - All ANLX-01 KPI events are emitted from real interaction points
    - Event params are stable and non-PII
    - DebugView can confirm event flow on device
    - No direct ad hoc analytics logging bypasses the service
  </done>
</task>

</tasks>

<verification>
1) Run `npx tsc --noEmit`.
2) Run the app on device and trigger each KPI action once.
3) Confirm all six events are visible in Firebase DebugView within the same session.
</verification>

<success_criteria>
- ANLX-01 fully implemented with six required KPI events
- Analytics integration uses RN Firebase module, not Firebase web analytics SDK
- Event names are standardized via one catalog and one service
- DebugView verification succeeds on at least one Android/iOS test pass
</success_criteria>

<output>
After completion, create `.planning/phases/7-polish-dnd-and-analytics/07-02-SUMMARY.md` with event taxonomy, exact callsites, DebugView evidence, and any schema adjustments.
</output>
