---
phase: 7-polish-dnd-and-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/DndService.ts
  - src/hooks/useSessionDnd.ts
  - src/stores/uiStore.ts
  - app/player.tsx
  - ios/QuietSessionModule.swift
  - android/app/src/main/java/com/calmasmrsounds/dnd/DndModule.kt
autonomous: true
requirements:
  - VIS-03

must_haves:
  truths:
    - "During active playback on Android, user can toggle Do Not Disturb in one tap and notification suppression applies once policy access is granted"
    - "During active playback on iOS, user can toggle Quiet Session in one tap and app applies interruption preference without claiming system-wide DND"
    - "If Android policy access is missing, user is routed to policy settings and can retry successfully"
    - "Toggle state is visible in-session and resets safely when playback session ends"
  artifacts:
    - path: "src/services/DndService.ts"
      provides: "Platform-gated DND facade with Android full support and iOS partial Quiet Session support"
      exports: ["DndService"]
    - path: "src/hooks/useSessionDnd.ts"
      provides: "Session lifecycle orchestration for apply/restore and permission handling"
      exports: ["useSessionDnd"]
    - path: "app/player.tsx"
      provides: "In-session DND/Quiet Session toggle UI and platform-specific copy"
      contains: "Quiet Session"
    - path: "src/stores/uiStore.ts"
      provides: "Persisted state for dndEnabled, dndCapability, and one-time iOS explainer flag"
      contains: "dndEnabled"
  key_links:
    - from: "app/player.tsx"
      to: "src/hooks/useSessionDnd.ts"
      via: "toggle calls useSessionDnd().setSessionQuietMode"
      pattern: "setSessionQuietMode"
    - from: "src/services/DndService.ts"
      to: "android/app/src/main/java/com/calmasmrsounds/dnd/DndModule.kt"
      via: "NativeModule bridge for policy access checks and interruption filter changes"
      pattern: "setInterruptionFilter"
    - from: "src/services/DndService.ts"
      to: "ios/QuietSessionModule.swift"
      via: "Native bridge to AVAudioSession.setPrefersNoInterruptionsFromSystemAlerts"
      pattern: "setPrefersNoInterruptionsFromSystemAlerts"
---

<objective>
Implement VIS-03 with platform-realistic behavior: Android gets true session DND control (with permission flow), and iOS gets a transparent Quiet Session fallback using public AVAudioSession interruption preference.

Purpose: DND is a high-risk phase item due to platform asymmetry. This plan creates a single, honest in-session control that behaves reliably and avoids App Store policy-risky workarounds.

Output: DndService + native bridges + player toggle wired with Android permission recovery and iOS constrained UX.
</objective>

<execution_context>
@/Users/manuelfrancogiraldez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/manuelfrancogiraldez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/7-polish-dnd-and-analytics/7-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build platform-gated DndService and native bridges</name>
  <files>
    src/services/DndService.ts
    ios/QuietSessionModule.swift
    android/app/src/main/java/com/calmasmrsounds/dnd/DndModule.kt
  </files>
  <action>
Create `DndService` as the only public API for session quiet mode. Expose: `getCapability()`, `getStatus()`, `setSessionQuietMode(enabled)`, `openPermissionSettings()`, and `restoreIfOwnedSession()`.

Android behavior: enforce `isNotificationPolicyAccessGranted()` before apply; if missing return `needs_permission`; when enabling snapshot `priorFilter`, apply `INTERRUPTION_FILTER_NONE`; on disable/session end restore `priorFilter` best-effort.

iOS behavior: expose a `QuietSessionModule` bridge that calls `AVAudioSession.sharedInstance().setPrefersNoInterruptionsFromSystemAlerts(enabled)` and returns success/failure. Do not attempt global Focus/DND control or private URL schemes.

In both platforms, return typed results (`applied`, `restored`, `needs_permission`, `unsupported`, `failed`) so caller UI stays deterministic.
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm 0 errors. Confirm native symbols exist with `setInterruptionFilter` in `android/app/src/main/java/com/calmasmrsounds/dnd/DndModule.kt` and `setPrefersNoInterruptionsFromSystemAlerts` in `ios/QuietSessionModule.swift`.
  </verify>
  <done>
    - `DndService` centralizes all DND/Quiet Session logic and hides platform differences
    - Android path supports policy access check, apply, and restore semantics
    - iOS path applies AVAudioSession interruption preference only (no false global DND claims)
    - Typed result contract is available to UI/hook layer
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire session lifecycle + player toggle UX</name>
  <files>
    src/hooks/useSessionDnd.ts
    src/stores/uiStore.ts
    app/player.tsx
  </files>
  <action>
Create `useSessionDnd` to orchestrate enable/disable during active playback, including Android permission reroute and restore on session end/stop. Store `dndEnabled`, `dndCapability`, and `iosQuietSessionExplainerSeen` in `uiStore`.

Update `app/player.tsx` with one in-session control:
- Android label: `Do Not Disturb`
- iOS label: `Quiet Session`

If Android permission missing, open policy settings via service and retry once app regains focus. On iOS first enable, show one-time explainer clarifying full system Focus remains user-controlled.

Do not expose this control outside active playback context and do not alter core playback flow.
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm 0 errors. Verify `app/player.tsx` contains platform-specific labels and calls `setSessionQuietMode`. Verify `uiStore` includes `dndEnabled` and `dndCapability` fields.
  </verify>
  <done>
    - Player has one-tap session quiet toggle with platform-correct copy
    - Android permission path guides user to settings and supports successful retry
    - iOS shows transparent one-time explainer and applies partial quiet behavior
    - Session end path triggers restore/reset without breaking playback
  </done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` and execute one Android + one iOS real-device smoke test:
1) Start playback and toggle ON
2) Validate platform-specific behavior (Android suppression with permission, iOS Quiet Session preference)
3) Stop playback and verify restore/reset path executes.
</verification>

<success_criteria>
- VIS-03 implemented with platform-realistic behavior (Android full DND, iOS Quiet Session fallback)
- Permission/error states are explicit and recoverable
- Toggle is in-session, visible, and safely reset/restored on session end
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/7-polish-dnd-and-analytics/07-01-SUMMARY.md` with applied capability model, native bridge notes, permission/restore behavior, and any platform deviations.
</output>
